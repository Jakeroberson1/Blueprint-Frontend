<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint - Canvas</title>

    <style>
        :root {
            --color-primary: #1769ff;
            --color-primary-hover: #0f58e6;
            --color-bg-primary: #070A13;
            --color-surface: rgba(255, 255, 255, 0.10);
            --color-surface-2: rgba(255, 255, 255, 0.06);
            --color-text-primary: rgba(255, 255, 255, 0.92);
            --color-text-secondary: rgba(255, 255, 255, 0.68);
            --color-border: rgba(255, 255, 255, 0.18);
            --color-success: #2be4a7;
            --color-warning: #ffc400;
            --color-error: #ff3b6a;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --shadow-sm: 0 10px 30px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 18px 60px rgba(0, 0, 0, 0.35);
            --glass-blur: 18px;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: "";
            position: fixed;
            inset: -20vh;
            pointer-events: none;
            z-index: -2;
            background:
                radial-gradient(60vw 50vh at 20% 20%, rgba(23, 105, 255, 0.45), transparent 60%),
                radial-gradient(50vw 45vh at 85% 25%, rgba(43, 228, 167, 0.35), transparent 60%),
                radial-gradient(55vw 50vh at 55% 85%, rgba(255, 59, 106, 0.22), transparent 60%);
        }

        body::after {
            z-index: -1;
            opacity: 0.45;
            background:
                radial-gradient(40vw 30vh at 25% 35%, rgba(255, 255, 255, 0.10), transparent 65%),
                radial-gradient(38vw 28vh at 70% 65%, rgba(255, 255, 255, 0.08), transparent 65%);
            mix-blend-mode: screen;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 18px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.08));
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 14px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .brand-wrap { display: flex; flex-direction: column; gap: 2px; }

        .brand-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--color-primary);
            line-height: 1.2;
            letter-spacing: 0.2px;
        }

        .brand-subtitle {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .account-wrap {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .user-pill {
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.10);
            border: 1px solid rgba(255, 255, 255, 0.16);
            color: rgba(255, 255, 255, 0.86);
            font-size: 13px;
            font-weight: 650;
        }

        .btn {
            appearance: none;
            border: none;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 999px;
            font-weight: 750;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.92);
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.16);
            transition: transform 0.15s ease, opacity 0.15s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover { transform: translateY(-1px); opacity: 0.95; }

        .btn-primary {
            background: linear-gradient(135deg, rgba(23, 105, 255, 0.92), rgba(255, 59, 106, 0.62));
            border: 1px solid rgba(255, 255, 255, 0.14);
            box-shadow: 0 12px 28px rgba(23, 105, 255, 0.20);
        }

        .btn-primary:hover { background: linear-gradient(135deg, rgba(23, 105, 255, 0.98), rgba(255, 59, 106, 0.68)); }

        .btn-ghost {
            background: rgba(255, 255, 255, 0.10);
        }

        .btn-danger {
            background: rgba(255, 59, 106, 0.16);
            border: 1px solid rgba(255, 59, 106, 0.30);
        }

        .btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
        }

        .header {
            text-align: center;
            padding: 16px 10px 20px;
        }

        .header h1 {
            margin: 0 0 6px;
            font-size: 40px;
            letter-spacing: 0.2px;
        }

        .header p {
            margin: 0;
            color: var(--color-text-secondary);
        }

        .grid {
            display: grid;
            grid-template-columns: 1.05fr 0.95fr;
            gap: 14px;
            align-items: start;
        }

        .card {
            padding: 18px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .card h2 {
            margin: 0 0 10px;
            font-size: 16px;
            letter-spacing: 0.2px;
        }

        .muted {
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        .field {
            margin-top: 12px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 750;
            color: rgba(255, 255, 255, 0.78);
            margin-bottom: 6px;
            letter-spacing: 0.2px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 14px;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: rgba(23, 105, 255, 0.70);
            box-shadow: 0 0 0 4px rgba(23, 105, 255, 0.14);
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .status {
            margin-top: 12px;
            font-size: 13px;
            padding: 10px 10px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.14);
            min-height: 40px;
            white-space: pre-wrap;
        }

        .codebox {
            margin-top: 12px;
            border-radius: var(--radius-lg);
            padding: 14px;
            background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 24px;
            letter-spacing: 2px;
            font-weight: 850;
            color: rgba(255, 255, 255, 0.95);
        }

        .code-meta {
            margin-top: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.66);
        }

        .steps {
            margin-top: 10px;
            display: grid;
            gap: 8px;
        }

        .step {
            display: grid;
            grid-template-columns: 26px 1fr;
            gap: 10px;
            align-items: start;
            padding: 10px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .step-num {
            width: 24px;
            height: 24px;
            display: grid;
            place-items: center;
            border-radius: 999px;
            background: rgba(23, 105, 255, 0.22);
            border: 1px solid rgba(23, 105, 255, 0.35);
            color: rgba(255, 255, 255, 0.90);
            font-weight: 850;
            font-size: 12px;
        }

        details {
            margin-top: 12px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 10px 12px;
        }

        summary {
            cursor: pointer;
            font-weight: 800;
        }

        .dash {
            display: none;
            margin-top: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .stat {
            padding: 14px;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            text-align: center;
        }

        .stat-num { font-size: 34px; font-weight: 900; color: var(--color-primary); line-height: 1.05; }
        .stat-label { font-size: 12px; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        .assignments {
            margin-top: 12px;
            max-height: 360px;
            overflow: auto;
            padding-right: 4px;
        }

        .assignment {
            padding: 12px;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            margin-bottom: 10px;
            border-left: 4px solid rgba(43, 228, 167, 0.70);
        }

        .assignment.urgent { border-left-color: rgba(255, 59, 106, 0.95); }
        .assignment.soon { border-left-color: rgba(255, 196, 0, 0.95); }

        .assignment-title { font-weight: 850; font-size: 14px; margin-bottom: 4px; }
        .assignment-course { font-size: 12px; color: var(--color-text-secondary); margin-bottom: 6px; }
        .assignment-due { font-size: 12px; font-weight: 800; }

        .empty {
            margin-top: 10px;
            padding: 12px;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            color: rgba(255, 255, 255, 0.70);
            font-size: 13px;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 34px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="brand-wrap">
                <div class="brand-title">Blueprint</div>
                <div class="brand-subtitle">AI Study Companion</div>
            </div>
            <div class="account-wrap">
                <a class="btn btn-ghost" href="index.html">Chat</a>
                <div class="user-pill" id="userPill">Signed in</div>
                <button class="btn btn-danger" id="logoutBtn" onclick="logout()">Log Out</button>
            </div>
        </div>

        <div class="header">
            <h1>Canvas</h1>
            <p>Sync courses, assignments, and grades using the Chrome extension (works with Microsoft 2FA).</p>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Connect Canvas (Extension)</h2>
                <div class="muted">You log into Canvas normally. Blueprint never asks for your Canvas password.</div>

                <div class="steps">
                    <div class="step"><div class="step-num">1</div><div>Generate a Link Code below.</div></div>
                    <div class="step"><div class="step-num">2</div><div>Open Canvas and sign in (Microsoft SSO + 2FA as usual).</div></div>
                    <div class="step"><div class="step-num">3</div><div>On Canvas, the <strong>Blueprint Sync</strong> panel appears. Paste the Link Code and click <strong>Pair</strong> (one time), then <strong>Sync now</strong>.</div></div>
                </div>

                <div class="field">
                    <label for="canvasUrl">Canvas URL (optional, just for the Open Canvas button)</label>
                    <input id="canvasUrl" type="text" placeholder="uvu.instructure.com" />
                </div>

                <div class="row">
                    <button class="btn btn-primary" id="linkBtn" onclick="generateLinkCode()">Generate Link Code</button>
                    <button class="btn btn-ghost" id="openCanvasBtn" onclick="openCanvas()">Open Canvas</button>
                    <button class="btn btn-ghost" id="refreshBtn" onclick="loadCanvasDashboard()">Refresh Dashboard</button>
                </div>

                <div id="linkCodeBox" class="codebox" style="display:none;">
                    <div class="code" id="linkCodeText">-----</div>
                    <div class="code-meta" id="linkCodeMeta"></div>
                    <div class="row" style="margin-top: 10px;">
                        <button class="btn btn-ghost" id="copyBtn" onclick="copyLinkCode()">Copy</button>
                        <a class="btn btn-ghost" href="#install">Install Instructions</a>
                    </div>
                </div>

                <div id="linkStatus" class="status" aria-live="polite">Ready.</div>

                <details id="install">
                    <summary>Install Instructions (Chrome)</summary>
                    <div class="muted" style="margin-top: 10px;">
                        1) Open <code>chrome://extensions</code><br>
                        2) Enable <strong>Developer mode</strong><br>
                        3) Click <strong>Load unpacked</strong><br>
                        4) Select the folder <code>blueprint-canvas-extension</code><br>
                        5) Go to Canvas and look for the bottom-right panel
                    </div>
                </details>
            </div>

            <div class="card">
                <h2>Your Canvas Data</h2>
                <div class="muted">After syncing via the extension, your dashboard will appear here.</div>

                <div id="emptyState" class="empty" style="display:none;">
                    No Canvas data yet. Generate a Link Code, sync via the extension on Canvas, then click "Refresh Dashboard".
                </div>

                <div id="dashboard" class="dash">
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-num" id="courseCount">0</div>
                            <div class="stat-label">Courses</div>
                        </div>
                        <div class="stat">
                            <div class="stat-num" id="assignmentCount">0</div>
                            <div class="stat-label">Assignments</div>
                        </div>
                    </div>

                    <div class="muted" style="margin-top: 12px;">Upcoming Assignments</div>
                    <div id="upcomingAssignments" class="assignments"></div>

                    <div class="muted" style="margin-top: 10px;" id="syncedAt"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_API_URL = 'https://blueprint-backend-154275778730.us-west1.run.app';
        const CANVAS_API_URL = `${BASE_API_URL}/api/canvas`;
        const LOGOUT_URL = `${BASE_API_URL}/auth/logout`;

        const sessionToken = localStorage.getItem('sessionToken');
        const currentUser = JSON.parse(localStorage.getItem('user') || 'null');

        function redirectToLogin() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function setUserUI() {
            const userPill = document.getElementById('userPill');
            const displayName = currentUser?.fullName || currentUser?.email || 'Signed in';
            userPill.textContent = displayName;
        }

        async function apiFetch(url, options = {}) {
            const headers = { ...(options.headers || {}) };
            if (sessionToken && !headers.Authorization) {
                headers.Authorization = `Bearer ${sessionToken}`;
            }

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                redirectToLogin();
                throw new Error('Session expired. Please sign in again.');
            }
            return response;
        }

        async function logout() {
            try {
                await apiFetch(LOGOUT_URL, { method: 'POST' });
            } catch (error) {}
            redirectToLogin();
        }

        function setStatus(message, type = 'info') {
            const box = document.getElementById('linkStatus');
            box.textContent = message;
            if (type === 'error') box.style.borderColor = 'rgba(255, 59, 106, 0.35)';
            else if (type === 'success') box.style.borderColor = 'rgba(43, 228, 167, 0.35)';
            else if (type === 'warning') box.style.borderColor = 'rgba(255, 196, 0, 0.35)';
            else box.style.borderColor = 'rgba(255, 255, 255, 0.14)';
        }

        function normalizeUrl(input) {
            const v = (input || '').trim();
            if (!v) return '';
            if (v.startsWith('http://') || v.startsWith('https://')) return v.replace(/\/$/, '');
            return `https://${v.replace(/\/$/, '')}`;
        }

        async function generateLinkCode() {
            const btn = document.getElementById('linkBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            setStatus('Generating a one-time Link Code...', 'warning');

            try {
                const resp = await apiFetch(`${CANVAS_API_URL}/link/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Failed to generate link code');

                const box = document.getElementById('linkCodeBox');
                const codeText = document.getElementById('linkCodeText');
                const codeMeta = document.getElementById('linkCodeMeta');

                codeText.textContent = json.linkCode;
                codeMeta.textContent = json.expiresAt ? `Expires: ${new Date(json.expiresAt).toLocaleString()}` : '';
                box.style.display = 'block';

                const canvasUrlInput = document.getElementById('canvasUrl');
                if (canvasUrlInput.value.trim()) {
                    localStorage.setItem('lastCanvasUrl', canvasUrlInput.value.trim());
                }

                setStatus('Link Code generated. Open Canvas, paste the code into the Blueprint Sync panel, then Sync.', 'success');
            } catch (e) {
                setStatus(`Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Link Code';
            }
        }

        async function copyLinkCode() {
            const code = document.getElementById('linkCodeText').textContent.trim();
            if (!code || code === '-----') return;

            try {
                await navigator.clipboard.writeText(code);
                setStatus('Copied Link Code to clipboard.', 'success');
            } catch (e) {
                setStatus('Copy failed. Select the code and copy manually.', 'warning');
            }
        }

        function openCanvas() {
            const input = document.getElementById('canvasUrl').value;
            const url = normalizeUrl(input);
            if (!url) {
                setStatus('Enter your Canvas URL first (e.g. uvu.instructure.com).', 'warning');
                return;
            }
            localStorage.setItem('lastCanvasUrl', input.trim());
            window.open(url, '_blank', 'noreferrer');
        }

        function renderAssignments(assignments) {
            const container = document.getElementById('upcomingAssignments');
            const list = Array.isArray(assignments) ? assignments : [];

            const upcoming = list
                .filter(a => a.due_at && new Date(a.due_at).getTime() > Date.now())
                .sort((a, b) => new Date(a.due_at) - new Date(b.due_at))
                .slice(0, 20);

            if (!upcoming.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No upcoming assignments found.</div>';
                return;
            }

            container.innerHTML = upcoming.map(a => {
                const dueDate = new Date(a.due_at);
                const daysUntil = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                const urgencyClass = daysUntil <= 2 ? 'urgent' : daysUntil <= 7 ? 'soon' : '';
                const urgencyColor = daysUntil <= 2 ? 'var(--color-error)' : daysUntil <= 7 ? 'var(--color-warning)' : 'var(--color-success)';

                return `
                    <div class="assignment ${urgencyClass}">
                        <div class="assignment-title">${a.name || 'Untitled'}</div>
                        <div class="assignment-course">${a.course_name || 'Course'}</div>
                        <div class="assignment-due" style="color: ${urgencyColor};">Due: ${dueDate.toLocaleDateString()} ${dueDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
            }).join('');
        }

        async function loadCanvasDashboard() {
            const empty = document.getElementById('emptyState');
            const dash = document.getElementById('dashboard');

            try {
                setStatus('Checking for synced Canvas data...', 'warning');
                const resp = await apiFetch(`${CANVAS_API_URL}/data`);

                if (resp.status === 404) {
                    empty.style.display = 'block';
                    dash.style.display = 'none';
                    setStatus('No Canvas data yet. Sync via extension first.', 'warning');
                    return;
                }

                const data = await resp.json();
                if (data.error) throw new Error(data.error);

                empty.style.display = 'none';
                dash.style.display = 'block';

                document.getElementById('courseCount').textContent = (data.courses || []).length;
                document.getElementById('assignmentCount').textContent = (data.assignments || []).length;

                renderAssignments(data.assignments || []);

                const syncedAt = data.synced_at ? new Date(data.synced_at).toLocaleString() : '';
                document.getElementById('syncedAt').textContent = syncedAt ? `Last synced: ${syncedAt}` : '';

                setStatus('Dashboard updated.', 'success');
            } catch (e) {
                setStatus(`Dashboard error: ${e.message}`, 'error');
            }
        }

        window.addEventListener('load', async () => {
            if (!sessionToken) {
                redirectToLogin();
                return;
            }

            setUserUI();

            const lastCanvasUrl = localStorage.getItem('lastCanvasUrl');
            if (lastCanvasUrl) {
                document.getElementById('canvasUrl').value = lastCanvasUrl;
            }

            try {
                const response = await apiFetch(`${BASE_API_URL}/auth/me`);
                if (!response.ok) redirectToLogin();
            } catch (error) {
                console.error('Auth check failed:', error);
            }

            // Try loading existing data on page open.
            await loadCanvasDashboard();
        });
    </script>
</body>
</html>
