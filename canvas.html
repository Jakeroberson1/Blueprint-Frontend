<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net data:; connect-src 'self' https://blueprint-backend-154275778730.us-west1.run.app; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
  <title>Blueprint - Connect Canvas</title>
  <style>
    :root {
      --ink: rgba(15,23,42,0.94);
      --ink-2: rgba(15,23,42,0.68);
      --glass: #fff;
      --stroke: rgba(229,231,235,1);
      --primary: #1a73e8;
      --radius-lg: 22px;
      --radius-md: 16px;
      --shadow-md: 0 18px 50px rgba(2, 6, 23, 0.10);
      --font: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--ink);
      background: radial-gradient(circle at 15% 20%, rgba(59,130,246,0.13), transparent 44%),
                  radial-gradient(circle at 80% 12%, rgba(43,228,167,0.12), transparent 38%),
                  #f7f7f8;
    }

    body.dark-mode {
      --ink: rgba(226, 232, 240, 0.96);
      --ink-2: rgba(203, 213, 225, 0.82);
      --glass: rgba(15, 23, 42, 1);
      --stroke: rgba(71, 85, 105, 0.7);
      background: radial-gradient(circle at 12% 18%, rgba(30,64,175,0.24), transparent 44%),
                  radial-gradient(circle at 82% 18%, rgba(6,182,212,0.18), transparent 40%),
                  #020617;
    }

    .container { max-width: 980px; margin: 0 auto; padding: 18px; }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--radius-lg);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 12px;
      z-index: 10;
    }

    .brand-title { font-weight: 900; font-size: 18px; }
    .brand-sub { font-size: 12px; color: var(--ink-2); font-weight: 700; }

    .account { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: color-mix(in srgb, var(--glass) 90%, #e5e7eb);
      font-size: 13px;
      font-weight: 800;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--ink);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 850;
      font-size: 13px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .btn-danger {
      background: rgba(239,68,68,1);
      border-color: rgba(239,68,68,1);
      color: #fff;
    }

    .hero { text-align: center; padding: 16px 8px 12px; }
    .hero h1 { margin: 8px 0 4px; font-size: 34px; letter-spacing: -0.6px; }
    .hero p { margin: 0; color: var(--ink-2); }

    .card {
      border-radius: var(--radius-lg);
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow-md);
      padding: 18px;
    }

    h2 { margin: 0 0 8px; }
    .muted { color: var(--ink-2); font-size: 13px; }

    .steps { margin-top: 12px; display: grid; gap: 10px; }
    .step {
      display: grid;
      grid-template-columns: 28px 1fr;
      gap: 10px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--stroke);
      background: color-mix(in srgb, var(--glass) 85%, #f3f4f6);
    }
    .step-num {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: var(--primary);
      color: #fff;
      font-weight: 900;
      font-size: 12px;
    }

    label { display: block; margin: 12px 0 6px; font-size: 12px; font-weight: 900; color: var(--ink-2); }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      color: var(--ink);
      outline: none;
    }

    .row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }

    .codebox {
      margin-top: 12px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--stroke);
      background: color-mix(in srgb, var(--glass) 88%, #f3f4f6);
      padding: 14px;
    }
    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 26px;
      letter-spacing: 2px;
      font-weight: 900;
    }
    .code-meta { margin-top: 8px; font-size: 12px; color: var(--ink-2); }

    .status {
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      min-height: 44px;
      white-space: pre-wrap;
      font-weight: 700;
    }

    details {
      margin-top: 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: var(--glass);
      padding: 10px 12px;
    }

    summary { cursor: pointer; font-weight: 900; }

    @media (max-width: 860px) {
      .hero h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <div class="brand-title">Blueprint</div>
        <div class="brand-sub">Canvas connection</div>
      </div>
      <div class="account">
        <a class="btn" href="canvas.html">Connect</a>
        <a class="btn" href="dashboard.html">Dashboard</a>
        <a class="btn" href="index.html">Chat</a>
        <a class="btn" href="settings.html">Settings</a>
        <button class="btn" type="button" onclick="showOnboarding()">Tour</button>
        <button class="btn" id="themeToggleBtn" type="button" onclick="toggleTheme()">Dark</button>
        <div class="pill" id="userPill">Signed in</div>
        <button class="btn btn-danger" onclick="logout()">Log Out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Connect Canvas</h1>
      <p>Pair once, then sync from Canvas any time.</p>
    </div>

    <div class="card">
      <h2>Pairing Instructions</h2>
      <div class="muted">Blueprint sync uses your browser session. No Canvas password is entered in Blueprint.</div>

      <div class="steps">
        <div class="step"><div class="step-num">1</div><div>Generate a Link Code below.</div></div>
        <div class="step"><div class="step-num">2</div><div>Install the extension and open Canvas.</div></div>
        <div class="step"><div class="step-num">3</div><div>In the Blueprint Sync panel on Canvas, paste code, pair once, then click <strong>Sync now</strong>.</div></div>
      </div>

      <label for="canvasUrl">Canvas URL (optional, for Open Canvas)</label>
      <input id="canvasUrl" type="text" placeholder="uvu.instructure.com" />

      <div class="row">
        <button class="btn btn-primary" id="linkBtn" onclick="generateLinkCode()">Generate Link Code</button>
        <a class="btn" href="blueprint-canvas-extension.zip" download>Download Extension ZIP</a>
        <a class="btn" href="privacy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
        <button class="btn" onclick="openCanvas()">Open Canvas</button>
        <a class="btn" href="dashboard.html">Go To Dashboard</a>
      </div>

      <div id="linkCodeBox" class="codebox" style="display:none;">
        <div class="code" id="linkCodeText">-----</div>
        <div class="code-meta" id="linkCodeMeta"></div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" onclick="copyLinkCode()">Copy</button>
          <a class="btn" href="#install">Install Instructions</a>
        </div>
      </div>

      <div id="linkStatus" class="status" aria-live="polite">Ready.</div>

      <details id="install">
        <summary>Install Instructions (Chrome)</summary>
        <div class="muted" style="margin-top:10px; line-height:1.55;">
          1) Download <code>blueprint-canvas-extension.zip</code> and unzip it.<br>
          2) Open <code>chrome://extensions</code><br>
          3) Enable <strong>Developer mode</strong><br>
          4) Click <strong>Load unpacked</strong> and select the unzipped <code>blueprint-canvas-extension</code> folder.<br>
          5) Go to Canvas and use the bottom-right Blueprint Sync panel.<br>
          6) Web Store release: once approved, this manual install will be replaced with one-click install.
        </div>
      </details>
    </div>
  </div>

  <script src="tour.js"></script>
  <script>
    try {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem('user');
    } catch (e) {}

    const BASE_API_URL = 'https://blueprint-backend-154275778730.us-west1.run.app';
    const CANVAS_API_URL = `${BASE_API_URL}/api/canvas`;
    const LOGOUT_URL = `${BASE_API_URL}/auth/logout`;
    const ONBOARDING_COMPLETE_URL = `${BASE_API_URL}/auth/onboarding-complete`;
    const THEME_STORAGE_KEY = 'bpTheme';
    const TOUR_STEPS = [
      { page: 'index.html', selector: '.chat-header', title: 'Ask Questions Fast', body: 'Use this chat area for your course questions. The composer at the bottom sends prompts, and Blueprint can give direct answers when needed.' },
      { page: 'index.html', selector: '#studyGuidePicker', title: 'Upload Files', body: 'Attach PDF, DOCX, TXT, or image files in chat for analysis. Use Study Guides in the left panel to build reusable guides from class content.' },
      { page: 'canvas.html', selector: '#linkBtn', title: 'Connect Canvas', body: 'Step 1: click Generate Link Code here. Step 2: download/install the extension ZIP (chrome://extensions -> Developer mode -> Load unpacked). Step 3: open your Canvas site and open the Blueprint Sync panel. Step 4: paste the Link Code and click Pair. Step 5: click Sync now, then return to Dashboard and press Refresh Dashboard.' },
      { page: 'dashboard.html', selector: '#priorityQueue', title: 'Use The Dashboard', body: 'This section highlights your highest-priority work from assignments, planner items, and calendar events.' },
      { page: 'settings.html', selector: '#timeZoneMode', title: 'Set Preferences', body: 'Open Settings to choose your timezone and dashboard defaults so due dates and day names stay accurate.' }
    ];

    const sessionToken = sessionStorage.getItem('sessionToken');
    const currentUser = JSON.parse(sessionStorage.getItem('user') || 'null');

    function applyTheme(theme) {
      const dark = theme === 'dark';
      document.body.classList.toggle('dark-mode', dark);
      const btn = document.getElementById('themeToggleBtn');
      if (btn) btn.textContent = dark ? 'Light' : 'Dark';
    }

    function getPreferredTheme() {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      if (stored === 'dark' || stored === 'light') return stored;
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function initializeTheme() {
      applyTheme(getPreferredTheme());
    }

    function toggleTheme() {
      const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      localStorage.setItem(THEME_STORAGE_KEY, next);
      applyTheme(next);
    }

    function redirectToLogin() {
      try {
        sessionStorage.removeItem('sessionToken');
        sessionStorage.removeItem('user');
      } catch (e) {}
      window.location.href = 'login.html';
    }

    async function apiFetch(url, options = {}) {
      const headers = { ...(options.headers || {}) };
      if (sessionToken && !headers.Authorization) headers.Authorization = `Bearer ${sessionToken}`;

      const response = await fetch(url, { ...options, headers });
      if (response.status === 401) {
        redirectToLogin();
        throw new Error('Session expired. Please sign in again.');
      }
      return response;
    }

    function setUserUI() {
      const pill = document.getElementById('userPill');
      pill.textContent = currentUser?.fullName || currentUser?.email || 'Signed in';
    }

    async function logout() {
      try { await apiFetch(LOGOUT_URL, { method: 'POST' }); } catch (e) {}
      redirectToLogin();
    }

    async function completeOnboarding() {
      try { await apiFetch(ONBOARDING_COMPLETE_URL, { method: 'POST' }); } catch (e) {}
      try {
        const user = JSON.parse(sessionStorage.getItem('user') || 'null') || {};
        user.hasSeenOnboarding = true;
        sessionStorage.setItem('user', JSON.stringify(user));
      } catch (e) {}
    }

    function showOnboarding() {
      if (window.startBlueprintTour) window.startBlueprintTour();
    }

    if (window.initBlueprintTour) {
      window.initBlueprintTour({
        steps: TOUR_STEPS,
        onComplete: completeOnboarding
      });
    }

    function setStatus(message, kind = 'info') {
      const box = document.getElementById('linkStatus');
      box.textContent = message;
      if (kind === 'error') box.style.borderColor = 'rgba(255, 59, 106, 0.55)';
      else if (kind === 'success') box.style.borderColor = 'rgba(43, 228, 167, 0.55)';
      else if (kind === 'warning') box.style.borderColor = 'rgba(255, 196, 0, 0.55)';
      else box.style.borderColor = 'rgba(229,231,235,1)';
    }

    function normalizeUrl(input) {
      const v = (input || '').trim();
      if (!v) return '';
      if (v.startsWith('http://') || v.startsWith('https://')) return v.replace(/\/$/, '');
      return `https://${v.replace(/\/$/, '')}`;
    }

    async function generateLinkCode() {
      const btn = document.getElementById('linkBtn');
      btn.disabled = true;
      btn.textContent = 'Generating...';
      setStatus('Generating a one-time Link Code...', 'warning');

      try {
        const resp = await apiFetch(`${CANVAS_API_URL}/link/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const json = await resp.json();
        if (!json.success) throw new Error(json.error || 'Failed to generate link code');

        document.getElementById('linkCodeText').textContent = json.linkCode;
        document.getElementById('linkCodeMeta').textContent = json.expiresAt ? `Expires: ${new Date(json.expiresAt).toLocaleString()}` : '';
        document.getElementById('linkCodeBox').style.display = 'block';

        const canvasUrlInput = document.getElementById('canvasUrl');
        if (canvasUrlInput.value.trim()) localStorage.setItem('lastCanvasUrl', canvasUrlInput.value.trim());

        setStatus('Link Code generated. Open Canvas, pair in the Blueprint Sync panel, then Sync.', 'success');
      } catch (e) {
        setStatus(`Error: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate Link Code';
      }
    }

    async function copyLinkCode() {
      const code = document.getElementById('linkCodeText').textContent.trim();
      if (!code || code === '-----') return;
      try {
        await navigator.clipboard.writeText(code);
        setStatus('Copied Link Code to clipboard.', 'success');
      } catch {
        setStatus('Copy failed. Select and copy manually.', 'warning');
      }
    }

    function openCanvas() {
      const input = document.getElementById('canvasUrl').value;
      const url = normalizeUrl(input);
      if (!url) {
        setStatus('Enter your Canvas URL first (e.g. uvu.instructure.com).', 'warning');
        return;
      }
      localStorage.setItem('lastCanvasUrl', input.trim());
      window.open(url, '_blank', 'noreferrer');
    }

    window.addEventListener('load', async () => {
      initializeTheme();
      if (!sessionToken) {
        redirectToLogin();
        return;
      }

      setUserUI();
      const lastCanvasUrl = localStorage.getItem('lastCanvasUrl');
      if (lastCanvasUrl) document.getElementById('canvasUrl').value = lastCanvasUrl;

      try {
        const response = await apiFetch(`${BASE_API_URL}/auth/me`);
        if (!response.ok) redirectToLogin();
      } catch (e) {}
    });
  </script>
</body>
</html>
