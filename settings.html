<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net data:; connect-src 'self' https://blueprint-backend-154275778730.us-west1.run.app; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
  <title>Blueprint - Settings</title>
    <link rel="stylesheet" href="shared-ui.css">
  <style>
    :root {
      --bg: rgba(248,250,252,1);
      --card: rgba(255,255,255,1);
      --ink: rgba(15,23,42,0.95);
      --ink-2: rgba(71,85,105,0.95);
      --stroke: rgba(229,231,235,1);
      --primary: rgba(26,115,232,1);
      --radius-lg: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f7f7f8;
      color: var(--ink);
    }
    body.dark-mode {
      --bg: rgba(10,15,25,1);
      --card: rgba(16,24,38,1);
      --ink: rgba(235,245,255,0.95);
      --ink-2: rgba(170,188,210,0.92);
      --stroke: rgba(51,65,85,0.8);
    }
    .container { max-width: 980px; margin: 0 auto; padding: 20px; }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      background: var(--card);
      padding: 12px 14px;
    }
    .brand-title { font-weight: 1000; letter-spacing: -0.02em; }
    .brand-sub { color: var(--ink-2); font-size: 12px; font-weight: 700; margin-top: 2px; }
    .account { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .pill { border: 1px solid var(--stroke); border-radius: 999px; padding: 8px 12px; font-weight: 700; color: var(--ink-2); }
    .btn {
      border: 1px solid var(--stroke);
      background: rgba(249,250,251,1);
      color: var(--ink);
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 800;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-primary { border-color: var(--primary); background: var(--primary); color: #fff; }
    .btn-danger { border-color: rgba(255,59,106,0.4); color: rgba(255,59,106,0.95); background: rgba(255,240,246,1); }
    .hero { margin: 18px 0 10px; }
    .hero h1 { margin: 0; font-size: 34px; }
    .hero p { margin: 8px 0 0; color: var(--ink-2); font-weight: 700; }
    .card {
      margin-top: 14px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      background: var(--card);
      padding: 16px;
    }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .field { display: grid; gap: 6px; }
    .label { font-size: 12px; font-weight: 900; color: var(--ink-2); text-transform: uppercase; }
    input, select {
      width: 100%;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,1);
      color: var(--ink);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 700;
    }
    body.dark-mode input, body.dark-mode select { background: rgba(15,23,42,0.7); color: var(--ink); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    .status {
      margin-top: 12px;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--ink-2);
      font-weight: 800;
    }
    @media (max-width: 840px) {
      .grid { grid-template-columns: 1fr; }
      .hero h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <div class="brand-title">Blueprint</div>
        <div class="brand-sub">Preferences</div>
      </div>
      <div class="account">
        <a class="btn" href="index.html">Chat</a>
        <a class="btn" href="dashboard.html">Dashboard</a>
        <a class="btn" href="canvas.html">Connect</a>
        <button class="btn" type="button" onclick="showOnboarding()">Tour</button>
        <button class="btn" id="themeToggleBtn" type="button" onclick="toggleTheme()">Dark</button>
        <div class="pill" id="userPill">Signed in</div>
        <button class="btn btn-danger" type="button" onclick="logout()">Log Out</button>
      </div>
    </div>

    <div class="hero">
      <h1>Settings</h1>
      <p>Control timezone behavior and dashboard defaults.</p>
    </div>

    <div class="card">
      <div class="grid">
        <div class="field">
          <label class="label" for="timeZoneMode">Timezone source</label>
          <select id="timeZoneMode" onchange="onTimeZoneModeChange(this.value)">
            <option value="auto">Use device timezone</option>
            <option value="custom">Use custom timezone</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="customTimeZone">Custom timezone</label>
          <select id="customTimeZone">
            <option value="America/New_York">Eastern</option>
            <option value="America/Chicago">Central</option>
            <option value="America/Denver">Mountain</option>
            <option value="America/Los_Angeles">Pacific</option>
            <option value="America/Phoenix">Arizona</option>
            <option value="UTC">UTC</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="defaultDashboardTab">Default dashboard tab</label>
          <select id="defaultDashboardTab">
            <option value="command">Command center</option>
            <option value="weekly">Weekly plan</option>
            <option value="overview">Overview</option>
            <option value="grades">Grades</option>
            <option value="planner">Planner</option>
            <option value="announcements">Announcements</option>
            <option value="inbox">Inbox</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="defaultDashboardFilter">Default dashboard filter</label>
          <select id="defaultDashboardFilter">
            <option value="all">All items</option>
            <option value="overdue">Overdue</option>
            <option value="next48h">Next 48h</option>
            <option value="week">This week</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button class="btn btn-primary" type="button" onclick="savePrefs()">Save Settings</button>
        <button class="btn" type="button" onclick="resetPrefs()">Reset Defaults</button>
        <a class="pill" href="privacy.html" target="_blank" rel="noopener noreferrer" style="padding:6px 10px; font-size:12px;">Privacy</a>
      </div>
      <div id="status" class="status">Ready.</div>
    </div>
  </div>

  <script src="tour.js"></script>
  <script>
    try {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem('user');
    } catch (e) {}

    const BASE_API_URL = 'https://blueprint-backend-154275778730.us-west1.run.app';
    const LOGOUT_URL = `${BASE_API_URL}/auth/logout`;
    const ONBOARDING_COMPLETE_URL = `${BASE_API_URL}/auth/onboarding-complete`;
    const THEME_STORAGE_KEY = 'bpTheme';
    const PREFS_STORAGE_KEY = 'bpPrefs';
    const TOUR_STEPS = [
      { page: 'index.html', selector: '.chat-header', title: 'Ask Questions Fast', body: 'Use this chat area for your course questions. The composer at the bottom sends prompts, and Blueprint can give direct answers when needed.' },
      { page: 'index.html', selector: '#studyGuidePicker', title: 'Upload Files', body: 'Attach PDF, DOCX, TXT, or image files in chat for analysis. Use Study Guides in the left panel to build reusable guides from class content.' },
      { page: 'canvas.html', selector: '#linkBtn', title: 'Connect Canvas', body: 'Step 1: click Generate Link Code here. Step 2: click Install from Chrome Web Store and add the extension. Step 3: open your Canvas site and use the Blueprint Sync panel. Step 4: paste the Link Code and click Pair. Step 5: click Sync now, then return to Dashboard and press Refresh Dashboard.' },
      { page: 'dashboard.html', selector: '#priorityQueue', title: 'Use The Dashboard', body: 'This section highlights your highest-priority work from assignments, planner items, and calendar events.' },
      { page: 'settings.html', selector: '#timeZoneMode', title: 'Set Preferences', body: 'Open Settings to choose your timezone and dashboard defaults so due dates and day names stay accurate.' }
    ];

    const sessionToken = sessionStorage.getItem('sessionToken');
    const currentUser = JSON.parse(sessionStorage.getItem('user') || 'null');

    function applyTheme(theme) {
      const dark = theme === 'dark';
      document.body.classList.toggle('dark-mode', dark);
      const btn = document.getElementById('themeToggleBtn');
      if (btn) btn.textContent = dark ? 'Light' : 'Dark';
    }
    function getPreferredTheme() {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      if (stored === 'dark' || stored === 'light') return stored;
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function initializeTheme() { applyTheme(getPreferredTheme()); }
    function toggleTheme() {
      const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      localStorage.setItem(THEME_STORAGE_KEY, next);
      applyTheme(next);
    }

    function redirectToLogin() {
      try {
        sessionStorage.removeItem('sessionToken');
        sessionStorage.removeItem('user');
      } catch (e) {}
      window.location.href = 'index.html';
    }

    async function apiFetch(url, options = {}) {
      const headers = { ...(options.headers || {}) };
      if (sessionToken && !headers.Authorization) headers.Authorization = `Bearer ${sessionToken}`;
      const response = await fetch(url, { ...options, headers });
      if (response.status === 401) {
        redirectToLogin();
        throw new Error('Session expired. Please sign in again.');
      }
      return response;
    }

    async function logout() {
      try { await apiFetch(LOGOUT_URL, { method: 'POST' }); } catch (e) {}
      redirectToLogin();
    }

    async function completeOnboarding() {
      try { await apiFetch(ONBOARDING_COMPLETE_URL, { method: 'POST' }); } catch (e) {}
      try {
        const user = JSON.parse(sessionStorage.getItem('user') || 'null') || {};
        user.hasSeenOnboarding = true;
        sessionStorage.setItem('user', JSON.stringify(user));
      } catch (e) {}
    }

    function showOnboarding() {
      if (window.startBlueprintTour) window.startBlueprintTour();
    }

    if (window.initBlueprintTour) {
      window.initBlueprintTour({
        steps: TOUR_STEPS,
        onComplete: completeOnboarding
      });
    }

    function setStatus(msg, isError = false) {
      const el = document.getElementById('status');
      el.textContent = msg || 'Ready.';
      el.style.borderColor = isError ? 'rgba(255,59,106,0.55)' : 'rgba(229,231,235,1)';
    }

    function readPrefs() {
      try {
        const raw = localStorage.getItem(PREFS_STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      } catch {
        return {};
      }
    }

    function writePrefs(prefs) {
      localStorage.setItem(PREFS_STORAGE_KEY, JSON.stringify(prefs || {}));
    }

    function onTimeZoneModeChange(value) {
      const custom = document.getElementById('customTimeZone');
      custom.disabled = value !== 'custom';
    }

    function loadPrefsIntoForm() {
      const prefs = readPrefs();
      const timeZoneMode = prefs.timeZoneMode || 'auto';
      document.getElementById('timeZoneMode').value = timeZoneMode;
      document.getElementById('customTimeZone').value = prefs.customTimeZone || 'America/Los_Angeles';
      document.getElementById('defaultDashboardTab').value = prefs.defaultDashboardTab || 'overview';
      document.getElementById('defaultDashboardFilter').value = prefs.defaultDashboardFilter || 'all';
      onTimeZoneModeChange(timeZoneMode);
    }

    function savePrefs() {
      const prefs = {
        timeZoneMode: document.getElementById('timeZoneMode').value || 'auto',
        customTimeZone: document.getElementById('customTimeZone').value || 'America/Los_Angeles',
        defaultDashboardTab: document.getElementById('defaultDashboardTab').value || 'overview',
        defaultDashboardFilter: document.getElementById('defaultDashboardFilter').value || 'all'
      };
      writePrefs(prefs);
      setStatus('Settings saved. Dashboard and chat will use these immediately.');
    }

    function resetPrefs() {
      writePrefs({
        timeZoneMode: 'auto',
        customTimeZone: 'America/Los_Angeles',
        defaultDashboardTab: 'overview',
        defaultDashboardFilter: 'all'
      });
      loadPrefsIntoForm();
      setStatus('Defaults restored.');
    }

    window.addEventListener('load', async () => {
      initializeTheme();
      if (!sessionToken) {
        redirectToLogin();
        return;
      }
      document.getElementById('userPill').textContent = currentUser?.fullName || currentUser?.email || 'Signed in';
      try {
        const response = await apiFetch(`${BASE_API_URL}/auth/me`);
        if (!response.ok) redirectToLogin();
      } catch (e) {}
      loadPrefsIntoForm();
    });
  </script>
</body>
</html>
