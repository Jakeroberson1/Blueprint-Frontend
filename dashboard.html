<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net data:; connect-src 'self' https://blueprint-backend-154275778730.us-west1.run.app; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
    <title>Blueprint - Canvas</title>
    <link rel="stylesheet" href="shared-ui.css">

    <style>
        :root {
            /* ChatGPT-style: clean light UI with bright blue accents */
            --ink: rgba(15, 23, 42, 0.94);
            --ink-2: rgba(15, 23, 42, 0.68);
            --ink-3: rgba(15, 23, 42, 0.50);

            --glass: rgba(255, 255, 255, 1);
            --glass-2: rgba(249, 250, 251, 1);
            --glass-3: rgba(243, 244, 246, 1);
            --stroke: rgba(229, 231, 235, 1);
            --stroke-2: rgba(209, 213, 219, 1);

            --primary: #1a73e8;
            --primary-2: #3b82f6;
            --mint: #2be4a7;
            --amber: #ffc400;
            --danger: #ff3b6a;

            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 22px;

            --shadow-sm: 0 8px 24px rgba(2, 6, 23, 0.08);
            --shadow-md: 0 18px 50px rgba(2, 6, 23, 0.10);
            --blur: 18px;

            --font: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            margin: 0;
            font-family: var(--font);
            color: var(--ink);
            background: #f7f7f8;
            overflow-x: hidden;
        }

        body.dark-mode {
            --ink: rgba(226, 232, 240, 0.96);
            --ink-2: rgba(203, 213, 225, 0.82);
            --ink-3: rgba(148, 163, 184, 0.72);
            --glass: rgba(15, 23, 42, 1);
            --glass-2: rgba(30, 41, 59, 1);
            --glass-3: rgba(30, 41, 59, 1);
            --stroke: rgba(71, 85, 105, 0.7);
            --stroke-2: rgba(71, 85, 105, 0.7);
            background: #020617;
        }

        body.dark-mode .topbar,
        body.dark-mode .card,
        body.dark-mode .step,
        body.dark-mode .status,
        body.dark-mode .codebox,
        body.dark-mode details,
        body.dark-mode .kpi,
        body.dark-mode .viz,
        body.dark-mode .item,
        body.dark-mode .focus-card,
        body.dark-mode .focus-item,
        body.dark-mode .empty,
        body.dark-mode input,
        body.dark-mode select {
            background: rgba(15, 23, 42, 1) !important;
            border-color: rgba(71, 85, 105, 0.7) !important;
            color: rgba(226, 232, 240, 0.96) !important;
        }

        body.dark-mode .btn,
        body.dark-mode .tab,
        body.dark-mode .pill,
        body.dark-mode .meta-note {
            background: rgba(30, 41, 59, 1) !important;
            border-color: rgba(71, 85, 105, 0.75) !important;
            color: rgba(226, 232, 240, 0.95) !important;
        }

        body.dark-mode .btn-primary,
        body.dark-mode .tab.active {
            background: rgba(37, 99, 235, 1) !important;
            border-color: rgba(37, 99, 235, 1) !important;
            color: rgba(248, 250, 252, 1) !important;
        }

        body::before {
            content: none;
        }

        .container {
            max-width: 1160px;
            margin: 0 auto;
            padding: 18px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--glass);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            position: sticky;
            top: 12px;
            z-index: 10;
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand-title {
            font-weight: 900;
            letter-spacing: 0.2px;
            font-size: 18px;
            color: rgba(15,23,42,0.96);
        }

        .brand-sub {
            font-size: 12px;
            color: var(--ink-2);
            font-weight: 650;
        }

        .account {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .pill {
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(243, 244, 246, 1);
            border: 1px solid rgba(229, 231, 235, 1);
            color: rgba(15,23,42,0.78);
            font-size: 13px;
            font-weight: 800;
            box-shadow: none;
        }

        .btn {
            appearance: none;
            border: none;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 13px;
            color: rgba(15, 23, 42, 0.88);
            background: rgba(255, 255, 255, 1);
            border: 1px solid rgba(229, 231, 235, 1);
            transition: transform 0.15s ease, filter 0.15s ease;
            text-decoration: none;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            box-shadow: none;
        }

        .btn:hover { transform: translateY(-1px); filter: saturate(1.06); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

        .btn-primary {
            color: rgba(255,255,255,0.96);
            background: rgba(26, 115, 232, 1);
            border: 1px solid rgba(26, 115, 232, 1);
            box-shadow: none;
        }

        .btn-danger {
            color: rgba(255,255,255,0.95);
            background: rgba(239, 68, 68, 1);
            border: 1px solid rgba(239, 68, 68, 1);
        }

        .hero {
            padding: 10px 8px 12px;
            text-align: center;
        }

        .hero h1 {
            margin: 8px 0 4px;
            font-size: 34px;
            letter-spacing: -0.6px;
        }

        .hero p {
            margin: 0;
            color: var(--ink-2);
            font-weight: 650;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
            align-items: start;
        }

        .card {
            border-radius: var(--radius-lg);
            background: rgba(255,255,255,1);
            border: 1px solid rgba(229,231,235,1);
            box-shadow: var(--shadow-md);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            padding: 18px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: none;
        }

        .card > * { position: relative; z-index: 1; }

        .card h2 {
            margin: 0 0 8px;
            font-size: 15px;
            letter-spacing: 0.25px;
        }

        .muted {
            color: var(--ink-2);
            font-size: 13px;
            font-weight: 650;
        }

        .steps {
            margin-top: 12px;
            display: grid;
            gap: 10px;
        }

        .step {
            display: grid;
            grid-template-columns: 28px 1fr;
            gap: 10px;
            padding: 12px;
            border-radius: var(--radius-md);
            background: rgba(249,250,251,1);
            border: 1px solid rgba(229,231,235,1);
            box-shadow: none;
        }

        .step-num {
            width: 24px;
            height: 24px;
            display: grid;
            place-items: center;
            border-radius: 999px;
            background: rgba(26,115,232,1);
            border: 1px solid rgba(26,115,232,1);
            color: rgba(255,255,255,0.96);
            font-weight: 950;
            font-size: 12px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 900;
            color: rgba(15,23,42,0.72);
            margin: 12px 0 6px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(209,213,219,1);
            background: rgba(255, 255, 255, 1);
            outline: none;
            font-size: 14px;
            color: rgba(15, 23, 42, 0.90);
            box-shadow: none;
        }

        input[type="text"]:focus {
            border-color: rgba(23,105,255,0.55);
            box-shadow: 0 0 0 4px rgba(23,105,255,0.14);
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .status {
            margin-top: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(229,231,235,1);
            background: rgba(255,255,255,1);
            min-height: 44px;
            white-space: pre-wrap;
            color: rgba(15,23,42,0.84);
            font-weight: 750;
        }

        .codebox {
            margin-top: 12px;
            border-radius: var(--radius-lg);
            padding: 14px;
            border: 1px solid rgba(229,231,235,1);
            background: rgba(249,250,251,1);
            box-shadow: none;
        }

        .code {
            font-family: var(--mono);
            font-size: 26px;
            letter-spacing: 2px;
            font-weight: 950;
            color: rgba(15,23,42,0.92);
        }

        .code-meta { margin-top: 8px; font-size: 12px; color: var(--ink-2); font-weight: 750; }

        details {
            margin-top: 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(229,231,235,1);
            background: rgba(255,255,255,1);
            padding: 10px 12px;
        }

        summary { cursor: pointer; font-weight: 950; color: rgba(15,23,42,0.84); }

        .dash {
            display: none;
            margin-top: 10px;
        }

        .kpis {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .kpi {
            border-radius: var(--radius-lg);
            border: 1px solid rgba(229,231,235,1);
            background: rgba(255,255,255,1);
            padding: 14px;
            box-shadow: none;
            overflow: hidden;
            position: relative;
        }

        .kpi::before {
            content: none;
        }

        .kpi > * { position: relative; z-index: 1; }

        .kpi-title { font-size: 12px; color: var(--ink-2); font-weight: 900; letter-spacing: 0.6px; text-transform: uppercase; }
        .kpi-big { font-size: 36px; font-weight: 1000; letter-spacing: -0.6px; margin-top: 4px; }
        .kpi-sub { margin-top: 2px; font-size: 12px; color: var(--ink-2); font-weight: 750; }

        .viz {
            margin-top: 12px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(229,231,235,1);
            background: rgba(255,255,255,1);
            padding: 14px;
            box-shadow: none;
        }

        .viz-title {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 10px;
        }

        .viz-title h3 {
            margin: 0;
            font-size: 13px;
            font-weight: 1000;
            letter-spacing: 0.3px;
        }

        .viz-title span { font-size: 12px; color: var(--ink-2); font-weight: 750; }

        .dash-controls {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .control {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .focus-grid {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .focus-card {
            border-radius: var(--radius-lg);
            border: 1px solid rgba(229,231,235,1);
            background: rgba(255,255,255,1);
            padding: 12px;
        }

        .focus-card h4 {
            margin: 0;
            font-size: 13px;
            font-weight: 1000;
            letter-spacing: 0.2px;
        }

        .focus-list {
            margin-top: 8px;
            display: grid;
            gap: 8px;
            max-height: 240px;
            overflow: auto;
        }

        .focus-item {
            border-radius: 12px;
            border: 1px solid rgba(229,231,235,1);
            background: rgba(249,250,251,1);
            padding: 8px 10px;
        }

        .focus-title { font-weight: 900; font-size: 12px; color: rgba(15,23,42,0.92); }
        .focus-meta { margin-top: 2px; font-size: 11px; font-weight: 700; color: rgba(15,23,42,0.62); }
        .focus-tag {
            display: inline-flex;
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 900;
            border: 1px solid rgba(26,115,232,0.25);
            background: rgba(232,240,254,1);
            color: rgba(26,115,232,1);
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        .workspace {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 12px;
            align-items: start;
        }
        .rail {
            position: sticky;
            top: 94px;
        }
        .rail .tabs {
            margin-top: 0;
            flex-direction: column;
            align-items: stretch;
            background: rgba(255,255,255,1);
            border: 1px solid rgba(229,231,235,1);
            border-radius: var(--radius-lg);
            padding: 10px;
            box-shadow: var(--shadow-sm);
        }
        .workspace-main {
            min-width: 0;
        }

        .tab {
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(229,231,235,1);
            background: rgba(243,244,246,1);
            color: rgba(15,23,42,0.86);
            font-weight: 950;
            cursor: pointer;
        }

        .tab.active {
            background: rgba(232, 240, 254, 1);
            border-color: rgba(26,115,232,0.35);
        }
        .panel {
            animation: fadeSlide 160ms ease;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .snapshot {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .snap-chip {
            border: 1px solid rgba(229,231,235,1);
            border-radius: 999px;
            padding: 6px 10px;
            background: rgba(249,250,251,1);
            font-size: 12px;
            font-weight: 900;
            color: var(--ink-2);
            cursor: pointer;
        }
        .snap-chip:hover { border-color: rgba(26,115,232,0.38); }
        .snap-chip strong { color: var(--ink); }
        .mini-toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 80;
            border: 1px solid rgba(229,231,235,1);
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.96);
            color: var(--ink);
            font-size: 12px;
            font-weight: 800;
            box-shadow: var(--shadow-sm);
            opacity: 0;
            transform: translateY(8px);
            pointer-events: none;
            transition: opacity 0.18s ease, transform 0.18s ease;
        }
        .mini-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .mobile-nav {
            display: none;
        }

        .list {
            margin-top: 12px;
            max-height: 440px;
            overflow: auto;
            padding-right: 4px;
        }

        .item {
            border-radius: var(--radius-lg);
            border: 1px solid rgba(229,231,235,1);
            background: rgba(255,255,255,1);
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: none;
            position: relative;
        }

        .item::before {
            content: none;
        }

        .item > * { position: relative; z-index: 1; }

        .item-title { font-weight: 1000; font-size: 14px; margin-bottom: 4px; }
        .item-meta { font-size: 12px; color: var(--ink-2); font-weight: 750; }
        .item-when { margin-top: 8px; font-size: 12px; font-weight: 950; color: rgba(23,105,255,0.92); }
        .mini-title {
            margin: 10px 0 6px;
            font-size: 12px;
            font-weight: 1000;
            color: var(--ink);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .command-grid {
            display: grid;
            grid-template-columns: 1.1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .command-card {
            border: 1px solid rgba(229,231,235,1);
            border-radius: var(--radius-lg);
            background: rgba(255,255,255,1);
            padding: 12px;
        }
        .risk-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 1000;
            text-transform: uppercase;
            border: 1px solid rgba(229,231,235,1);
        }
        .risk-chip.high { color: rgba(220,38,38,1); background: rgba(254,242,242,1); border-color: rgba(252,165,165,1); }
        .risk-chip.medium { color: rgba(161,98,7,1); background: rgba(254,249,195,1); border-color: rgba(253,224,71,1); }
        .risk-chip.low { color: rgba(22,101,52,1); background: rgba(240,253,244,1); border-color: rgba(134,239,172,1); }
        .planner-day {
            border: 1px solid rgba(229,231,235,1);
            border-radius: 12px;
            background: rgba(249,250,251,1);
            padding: 10px;
            margin-bottom: 8px;
        }
        .planner-day h5 {
            margin: 0 0 4px;
            font-size: 12px;
            font-weight: 1000;
            color: var(--ink);
            letter-spacing: 0.2px;
        }
        .planner-day p {
            margin: 0;
            font-size: 12px;
            color: var(--ink-2);
            font-weight: 700;
        }
        .loading {
            position: relative;
            overflow: hidden;
        }
        .loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent);
            animation: shimmer 1.2s infinite;
        }
        @keyframes shimmer {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }


        .heatmap {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(14, minmax(0, 1fr));
            gap: 7px;
        }

        .heatcell {
            border-radius: 12px;
            border: 1px solid rgba(229,231,235,1);
            background: rgba(249,250,251,1);
            padding: 7px 6px;
            min-height: 66px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .heatdate { font-size: 10px; font-weight: 800; color: var(--ink-2); }
        .heatcount { font-size: 18px; font-weight: 1000; letter-spacing: -0.4px; color: var(--ink); }

        .empty {
            margin-top: 10px;
            padding: 12px;
            border-radius: var(--radius-lg);
            background: rgba(249,250,251,1);
            border: 1px dashed rgba(229,231,235,1);
            color: var(--ink-2);
            font-size: 13px;
            font-weight: 750;
        }

        @media (max-width: 980px) {
            .grid { grid-template-columns: 1fr; }
            .hero h1 { font-size: 34px; }
            .kpis { grid-template-columns: 1fr; }
            .focus-grid { grid-template-columns: 1fr; }
            .dash-controls { grid-template-columns: 1fr; }
            .heatmap { grid-template-columns: repeat(7, minmax(0, 1fr)); }
            .command-grid { grid-template-columns: 1fr; }
            .workspace { grid-template-columns: 1fr; }
            .rail { position: static; }
            .rail .tabs {
                flex-direction: row;
                overflow-x: auto;
            }
            .mobile-nav {
                position: fixed;
                left: 10px;
                right: 10px;
                bottom: 10px;
                z-index: 60;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                border: 1px solid rgba(229,231,235,1);
                border-radius: 14px;
                padding: 8px;
                background: rgba(255,255,255,0.97);
                box-shadow: var(--shadow-sm);
            }
            .mobile-nav a {
                text-align: center;
                font-size: 12px;
                font-weight: 900;
                color: var(--ink);
                text-decoration: none;
                padding: 8px 6px;
                border-radius: 10px;
                border: 1px solid rgba(229,231,235,1);
                background: rgba(249,250,251,1);
            }
            .container { padding-bottom: 90px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="topbar">
            <div class="brand">
                <div class="brand-title">Blueprint</div>
                <div class="brand-sub">Canvas dashboard</div>
            </div>
            <div class="account">
                <a class="btn" href="canvas.html">Connect</a>
                <a class="btn" href="index.html">Chat</a>
                <a class="btn" href="settings.html">Settings</a>
                <button class="btn" type="button" onclick="showOnboarding()">Tour</button>
                <button class="btn" id="themeToggleBtn" type="button" onclick="toggleTheme()">Dark</button>
                <div class="pill" id="userPill">Signed in</div>
                <button class="btn btn-danger" onclick="logout()">Log Out</button>
            </div>
        </div>

        <div class="hero">
            <h1>Dashboard</h1>
            <p>Your Canvas data, organized into a daily plan.</p>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Your Canvas Data</h2>
                <div class="muted">Daily view of what to do next.</div>
                <div class="row" style="margin-top:10px;">
                    <button class="btn btn-primary" id="refreshBtn" type="button" onclick="loadCanvasDashboard()">Refresh Dashboard</button>
                    <a class="btn" href="canvas.html">Open Connect Page</a>
                </div>
                <div id="dashboardStatus" class="status" aria-live="polite" style="margin-top:10px;">Ready.</div>
                <div class="row" style="margin-top:8px;">
                    <button class="btn" id="retryBtn" type="button" onclick="loadCanvasDashboard()" style="display:none;">Retry Load</button>
                </div>

                <div id="emptyState" class="empty" style="display:none;">
                    No Canvas data yet. Open the Connect page, pair your account, sync once, then refresh.
                </div>

                <div id="dashboard" class="dash">
                    <div class="kpis">
                        <div class="kpi" role="button" tabindex="0" onclick="setDashTab('overview')">
                            <div class="kpi-title">Courses</div>
                            <div class="kpi-big" id="kpiCourses">0</div>
                            <div class="kpi-sub" id="kpiBusiest">Busiest day: -</div>
                        </div>
                        <div class="kpi" role="button" tabindex="0" onclick="setDashTab('overview')">
                            <div class="kpi-title">Assignments</div>
                            <div class="kpi-big" id="kpiAssignments">0</div>
                            <div class="kpi-sub" id="kpiNextDue">Next due: -</div>
                        </div>
                        <div class="kpi" role="button" tabindex="0" onclick="setDashTab('planner')">
                            <div class="kpi-title">Planner + Calendar</div>
                            <div class="kpi-big" id="kpiEvents">0</div>
                            <div class="kpi-sub" id="kpiSyncedAt">Last sync: -</div>
                        </div>
                    </div>

                    <div class="snapshot" id="todaySnapshot">
                        <button class="snap-chip" type="button" onclick="setQuickFilter('overdue')">Overdue: <strong id="snapOverdue">0</strong></button>
                        <button class="snap-chip" type="button" onclick="setQuickFilter('next48h')">Next 48h: <strong id="snap48h">0</strong></button>
                        <button class="snap-chip" type="button" onclick="setDashTab('inbox')">Inbox New: <strong id="snapInbox">0</strong></button>
                    </div>

                    <div class="viz" style="margin-top: 12px;">
                        <div class="viz-title">
                            <h3>Workload Heatmap</h3>
                            <span>Next 14 days, action density</span>
                        </div>
                        <div id="pulseViz" style="margin-top: 10px;"></div>
                    </div>

                    <div class="viz" style="margin-top: 12px;">
                        <div class="viz-title">
                            <h3>Course Mix</h3>
                            <span>Assignments by course</span>
                        </div>
                        <div id="courseViz" style="margin-top: 10px;"></div>
                    </div>

                    <div class="workspace">
                        <div class="rail">
                            <div class="tabs" id="dashTabs">
                                <button class="tab" type="button" id="tabCommand" data-tab="command">Command Center</button>
                                <button class="tab" type="button" id="tabWeekly" data-tab="weekly">Weekly Plan</button>
                                <button class="tab" type="button" id="tabOverview" data-tab="overview">Overview</button>
                                <button class="tab" type="button" id="tabGrades" data-tab="grades">Grades</button>
                                <button class="tab" type="button" id="tabPlanner" data-tab="planner">Planner</button>
                                <button class="tab" type="button" id="tabAnnouncements" data-tab="announcements">Announcements</button>
                                <button class="tab" type="button" id="tabInbox" data-tab="inbox">Inbox</button>
                            </div>
                        </div>
                        <div class="workspace-main">
                    <div class="dash-controls">
                        <div class="control">
                            <label for="courseFilter" style="margin: 0; font-size: 12px; font-weight: 900;">Filter by course</label>
                            <select id="courseFilter" class="input-sm" style="max-width: 100%; padding: 8px 10px;" onchange="onCourseFilterChange(this.value)">
                                <option value="__all__">All courses</option>
                            </select>
                        </div>
                        <div class="control">
                            <label for="dashboardSearch" style="margin: 0; font-size: 12px; font-weight: 900;">Search dashboard</label>
                            <input id="dashboardSearch" type="text" class="input-sm" style="padding: 8px 10px;" placeholder="Search..." oninput="onDashboardSearch(this.value)" />
                        </div>
                    </div>
                    <div class="row" style="margin-top: 10px; gap: 8px; flex-wrap: wrap;">
                        <button class="btn" type="button" id="quickAll" onclick="setQuickFilter('all')">All Items</button>
                        <button class="btn" type="button" id="quickOverdue" onclick="setQuickFilter('overdue')">Overdue</button>
                        <button class="btn" type="button" id="quick48h" onclick="setQuickFilter('next48h')">Next 48h</button>
                        <button class="btn" type="button" id="quickWeek" onclick="setQuickFilter('week')">This Week</button>
                    </div>

                    <div class="focus-grid">
                        <div class="focus-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                                <h4>Todayâ€™s Top 3</h4>
                                <button class="btn" type="button" style="padding: 6px 10px;" onclick="focusToday()">What should I do today?</button>
                            </div>
                            <div class="muted" style="margin-top: 4px;">Most urgent items right now.</div>
                            <div id="priorityQueue" class="focus-list"></div>
                        </div>
                        <div class="focus-card">
                            <h4>Quick Actions</h4>
                            <div class="muted" style="margin-top: 4px;">Concrete next moves based on your current data.</div>
                            <div id="quickActions" class="focus-list"></div>
                        </div>
                    </div>

                    <div id="dashPanelCommand" class="panel" style="display:none;">
                        <div class="command-grid">
                            <div class="command-card">
                                <div class="mini-title">Do Now Queue</div>
                                <div id="commandQueue" class="focus-list"></div>
                            </div>
                            <div class="command-card">
                                <div class="mini-title">Grade Watch</div>
                                <div id="gradeWatchList" class="focus-list"></div>
                            </div>
                        </div>
                        <div class="command-card" style="margin-top:12px;">
                            <div class="mini-title">Inbox to Action</div>
                            <div id="messageActions" class="focus-list"></div>
                        </div>
                    </div>

                    <div id="dashPanelWeekly" class="panel" style="display:none;">
                        <div class="row" style="margin-top: 10px; gap: 8px;">
                            <button class="btn btn-primary" type="button" onclick="generateWeeklyPlan()">Generate 7-day plan</button>
                            <button class="btn" type="button" onclick="copyWeeklyPlan()">Copy plan</button>
                        </div>
                        <div class="muted" style="margin-top: 8px;">Builds a practical weekly study sequence from due dates, inbox updates, and grade risk.</div>
                        <div id="weeklyPlanList" class="list"></div>
                    </div>

                    <div id="dashPanelOverview" class="panel">
                        <div class="muted" style="margin-top: 10px;">Upcoming assignments (top 20)</div>
                        <div id="upcomingAssignments" class="list"></div>
                    </div>

                    <div id="dashPanelGrades" class="panel" style="display:none;">
                        <div class="muted" style="margin-top: 10px;">Grade summary</div>
                        <div id="gradesList" class="list"></div>
                    </div>

                    <div id="dashPanelPlanner" class="panel" style="display:none;">
                        <div class="muted" style="margin-top: 10px;">Planner + Calendar timeline (next 90 days)</div>
                        <div id="plannerList" class="list"></div>
                    </div>

                    <div id="dashPanelAnnouncements" class="panel" style="display:none;">
                        <div class="muted" style="margin-top: 10px;">Announcements</div>
                        <div id="announcementsList" class="list"></div>
                    </div>

                    <div id="dashPanelInbox" class="panel" style="display:none;">
                        <div class="muted" style="margin-top: 10px;">Instructor messages (announcements + Canvas inbox)</div>
                        <div id="inboxList" class="list"></div>
                    </div>

                    <details style="margin-top: 12px;">
                        <summary>More Data (Optional)</summary>
                        <div class="muted" style="margin-top: 10px;">Modules</div>
                        <div id="modulesList" class="list"></div>
                        <div class="muted" style="margin-top: 10px;">Submissions</div>
                        <div id="submissionsList" class="list"></div>
                        <div class="muted" style="margin-top: 10px;">Discussions</div>
                        <div id="discussionsList" class="list"></div>
                        <div class="muted" style="margin-top: 10px;">Syllabi</div>
                        <div id="syllabiList" class="list"></div>
                    </details>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="mobile-nav" aria-label="Quick navigation">
        <a href="index.html">Chat</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="canvas.html">Connect</a>
    </nav>
    <div id="miniToast" class="mini-toast" aria-live="polite"></div>

    <script src="tour.js"></script>
    <script>
        // Session-scoped auth; remove legacy persistent tokens.
        try {
            localStorage.removeItem('sessionToken');
            localStorage.removeItem('user');
        } catch (e) {}

        const BASE_API_URL = 'https://blueprint-backend-154275778730.us-west1.run.app';
        const CANVAS_API_URL = `${BASE_API_URL}/api/canvas`;
        const LOGOUT_URL = `${BASE_API_URL}/auth/logout`;
        const ONBOARDING_COMPLETE_URL = `${BASE_API_URL}/auth/onboarding-complete`;
        const THEME_STORAGE_KEY = 'bpTheme';
        const PREFS_STORAGE_KEY = 'bpPrefs';
        const TOUR_STEPS = [
            { page: 'index.html', selector: '.chat-header', title: 'Ask Questions Fast', body: 'Use this chat area for your course questions. The composer at the bottom sends prompts, and Blueprint can give direct answers when needed.' },
            { page: 'index.html', selector: '#studyGuidePicker', title: 'Upload Files', body: 'Attach PDF, DOCX, TXT, or image files in chat for analysis. Use Study Guides in the left panel to build reusable guides from class content.' },
            { page: 'canvas.html', selector: '#linkBtn', title: 'Connect Canvas', body: 'Step 1: click Generate Link Code here. Step 2: click Install from Chrome Web Store and add the extension. Step 3: open your Canvas site and use the Blueprint Sync panel. Step 4: paste the Link Code and click Pair. Step 5: click Sync now, then return to Dashboard and press Refresh Dashboard.' },
            { page: 'dashboard.html', selector: '#priorityQueue', title: 'Use The Dashboard', body: 'This section highlights your highest-priority work from assignments, planner items, and calendar events.' },
            { page: 'settings.html', selector: '#timeZoneMode', title: 'Set Preferences', body: 'Open Settings to choose your timezone and dashboard defaults so due dates and day names stay accurate.' }
        ];

        const sessionToken = sessionStorage.getItem('sessionToken');
        const currentUser = JSON.parse(sessionStorage.getItem('user') || 'null');
        let currentCanvasData = null;
        let currentCanvasOrigin = '';
        let userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        let selectedCourse = '__all__';
        let dashboardSearch = '';
        let quickFilter = 'all';
        let defaultDashboardTab = 'overview';
        let weeklyPlanText = '';
        let upcomingExpanded = false;
        let inboxExpanded = false;
        let quickActionsExpanded = false;
        let lastShortcutKey = '';
        let lastShortcutTs = 0;

        function applyTheme(theme) {
            const dark = theme === 'dark';
            document.body.classList.toggle('dark-mode', dark);
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.textContent = dark ? 'Light' : 'Dark';
        }
        function getPreferredTheme() {
            const stored = localStorage.getItem(THEME_STORAGE_KEY);
            if (stored === 'dark' || stored === 'light') return stored;
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        function initializeTheme() {
            applyTheme(getPreferredTheme());
        }
        function toggleTheme() {
            const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            localStorage.setItem(THEME_STORAGE_KEY, next);
            applyTheme(next);
        }

        function redirectToLogin() {
            try {
                sessionStorage.removeItem('sessionToken');
                sessionStorage.removeItem('user');
            } catch (e) {}
            window.location.href = 'index.html';
        }

        async function apiFetch(url, options = {}) {
            const headers = { ...(options.headers || {}) };
            if (sessionToken && !headers.Authorization) headers.Authorization = `Bearer ${sessionToken}`;

            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) {
                redirectToLogin();
                throw new Error('Session expired. Please sign in again.');
            }
            return response;
        }

        function setUserUI() {
            const pill = document.getElementById('userPill');
            pill.textContent = currentUser?.fullName || currentUser?.email || 'Signed in';
        }

        function getPrefs() {
            try {
                const raw = localStorage.getItem(PREFS_STORAGE_KEY);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch {
                return {};
            }
        }

        function readDashboardPrefs() {
            const prefs = getPrefs();
            const configuredTz = prefs?.timeZoneMode === 'custom' ? String(prefs.customTimeZone || '').trim() : '';
            userTimeZone = configuredTz || (Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC');
            quickFilter = String(prefs.defaultDashboardFilter || 'all');
            if (!['all', 'overdue', 'next48h', 'week'].includes(quickFilter)) quickFilter = 'all';
            defaultDashboardTab = String(prefs.defaultDashboardTab || 'overview');
            if (!['command', 'weekly', 'overview', 'grades', 'planner', 'announcements', 'inbox'].includes(defaultDashboardTab)) defaultDashboardTab = 'overview';
        }

        async function logout() {
            try { await apiFetch(LOGOUT_URL, { method: 'POST' }); } catch (e) {}
            redirectToLogin();
        }

        async function completeOnboarding() {
            try { await apiFetch(ONBOARDING_COMPLETE_URL, { method: 'POST' }); } catch (e) {}
            try {
                const user = JSON.parse(sessionStorage.getItem('user') || 'null') || {};
                user.hasSeenOnboarding = true;
                sessionStorage.setItem('user', JSON.stringify(user));
            } catch (e) {}
        }

        function showOnboarding() {
            if (window.startBlueprintTour) window.startBlueprintTour();
        }

        if (window.initBlueprintTour) {
            window.initBlueprintTour({
                steps: TOUR_STEPS,
                onComplete: completeOnboarding
            });
        }

        function setStatus(message, kind = 'info') {
            const box = document.getElementById('dashboardStatus');
            const retryBtn = document.getElementById('retryBtn');
            if (!box) return;
            box.textContent = message;
            if (kind === 'error') box.style.borderColor = 'rgba(255, 59, 106, 0.55)';
            else if (kind === 'success') box.style.borderColor = 'rgba(43, 228, 167, 0.55)';
            else if (kind === 'warning') box.style.borderColor = 'rgba(255, 196, 0, 0.55)';
            else box.style.borderColor = 'rgba(229,231,235,1)';
            if (retryBtn) retryBtn.style.display = kind === 'error' ? 'inline-flex' : 'none';
        }

        function showToast(message) {
            const toast = document.getElementById('miniToast');
            if (!toast) return;
            toast.textContent = String(message || '');
            toast.classList.add('show');
            clearTimeout(showToast._t);
            showToast._t = setTimeout(() => toast.classList.remove('show'), 1800);
        }

        function normalizeUrl(input) {
            const v = (input || '').trim();
            if (!v) return '';
            if (v.startsWith('http://') || v.startsWith('https://')) return v.replace(/\/$/, '');
            return `https://${v.replace(/\/$/, '')}`;
        }

        async function generateLinkCode() {
            const btn = document.getElementById('linkBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            setStatus('Generating a one-time Link Code...', 'warning');

            try {
                const resp = await apiFetch(`${CANVAS_API_URL}/link/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Failed to generate link code');

                document.getElementById('linkCodeText').textContent = json.linkCode;
                document.getElementById('linkCodeMeta').textContent = json.expiresAt ? `Expires: ${new Date(json.expiresAt).toLocaleString()}` : '';
                document.getElementById('linkCodeBox').style.display = 'block';

                const canvasUrlInput = document.getElementById('canvasUrl');
                if (canvasUrlInput.value.trim()) localStorage.setItem('lastCanvasUrl', canvasUrlInput.value.trim());

                setStatus('Link Code generated. Open Canvas, pair in the Blueprint Sync panel, then Sync.', 'success');
            } catch (e) {
                setStatus(`Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Link Code';
            }
        }

        async function copyLinkCode() {
            const code = document.getElementById('linkCodeText').textContent.trim();
            if (!code || code === '-----') return;

            try {
                await navigator.clipboard.writeText(code);
                setStatus('Copied Link Code to clipboard.', 'success');
                showToast('Link code copied');
            } catch {
                setStatus('Copy failed. Select and copy manually.', 'warning');
            }
        }

        function openCanvas() {
            const input = document.getElementById('canvasUrl').value;
            const url = normalizeUrl(input);
            if (!url) {
                setStatus('Enter your Canvas URL first (e.g. uvu.instructure.com).', 'warning');
                return;
            }
            localStorage.setItem('lastCanvasUrl', input.trim());
            window.open(url, '_blank', 'noreferrer');
        }

        function setDashTab(tab) {
            const tabMap = {
                command: { btn: 'tabCommand', panel: 'dashPanelCommand' },
                weekly: { btn: 'tabWeekly', panel: 'dashPanelWeekly' },
                overview: { btn: 'tabOverview', panel: 'dashPanelOverview' },
                grades: { btn: 'tabGrades', panel: 'dashPanelGrades' },
                planner: { btn: 'tabPlanner', panel: 'dashPanelPlanner' },
                announcements: { btn: 'tabAnnouncements', panel: 'dashPanelAnnouncements' },
                inbox: { btn: 'tabInbox', panel: 'dashPanelInbox' },
            };
            const keys = Object.keys(tabMap);
            const target = tabMap[tab] ? tab : 'overview';

            for (const t of keys) {
                const btn = document.getElementById(tabMap[t].btn);
                const panel = document.getElementById(tabMap[t].panel);
                if (panel) panel.style.display = (t === target) ? 'block' : 'none';
                if (btn) btn.classList.toggle('active', t === target);
            }
        }

        function initDashTabs() {
            const root = document.getElementById('dashTabs');
            if (!root) return;
            root.querySelectorAll('.tab[data-tab]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab') || 'overview';
                    setDashTab(tab);
                });
            });
        }

        function refreshQuickFilterButtons() {
            const map = {
                all: 'quickAll',
                overdue: 'quickOverdue',
                next48h: 'quick48h',
                week: 'quickWeek'
            };
            for (const [key, id] of Object.entries(map)) {
                const btn = document.getElementById(id);
                if (!btn) continue;
                const active = quickFilter === key;
                btn.classList.toggle('btn-primary', active);
            }
        }

        function setQuickFilter(mode) {
            quickFilter = ['all', 'overdue', 'next48h', 'week'].includes(mode) ? mode : 'all';
            refreshQuickFilterButtons();
            if (!currentCanvasData) return;
            renderDashboard(currentCanvasData);
        }

        function focusToday() {
            setDashTab('overview');
            const el = document.getElementById('priorityQueue');
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setStatus('Focus mode: top 3 priorities are highlighted below.', 'success');
        }

        function esc(s) {
            return String(s || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        function parseCanvasDate(value) {
            if (value === null || value === undefined || value === '') return null;
            if (value instanceof Date) return Number.isNaN(value.getTime()) ? null : value;
            if (typeof value === 'number') {
                const ms = value > 1e12 ? value : value > 1e9 ? value * 1000 : value;
                const d = new Date(ms);
                return Number.isNaN(d.getTime()) ? null : d;
            }
            const s = String(value).trim();
            if (!s) return null;
            if (/^\d+$/.test(s)) {
                const n = Number(s);
                const ms = n > 1e12 ? n : n > 1e9 ? n * 1000 : n;
                const d = new Date(ms);
                if (!Number.isNaN(d.getTime())) return d;
            }
            // Canvas all-day values (YYYY-MM-DD). Parse as local midday to avoid UTC day-shift issues.
            const dateOnly = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (dateOnly) {
                const y = Number(dateOnly[1]);
                const m = Number(dateOnly[2]) - 1;
                const d = Number(dateOnly[3]);
                const local = new Date(y, m, d, 12, 0, 0, 0);
                return Number.isNaN(local.getTime()) ? null : local;
            }
            // ISO-like datetime without timezone (treat as local time).
            const localDateTime = s.match(/^(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})(?::(\d{2}))?(?:\.(\d+))?$/);
            if (localDateTime) {
                const y = Number(localDateTime[1]);
                const m = Number(localDateTime[2]) - 1;
                const d = Number(localDateTime[3]);
                const hh = Number(localDateTime[4]);
                const mm = Number(localDateTime[5]);
                const ss = Number(localDateTime[6] || 0);
                const ms = Number(String(localDateTime[7] || '0').slice(0, 3).padEnd(3, '0'));
                const local = new Date(y, m, d, hh, mm, ss, ms);
                return Number.isNaN(local.getTime()) ? null : local;
            }
            const d = new Date(s);
            return Number.isNaN(d.getTime()) ? null : d;
        }

        function formatWhen(dt) {
            const d = parseCanvasDate(dt);
            if (!d) return String(dt || '');
            try {
                return new Intl.DateTimeFormat(undefined, {
                    dateStyle: 'medium',
                    timeStyle: 'short',
                    timeZoneName: 'short',
                    timeZone: userTimeZone
                }).format(d);
            } catch {
                try {
                    return new Intl.DateTimeFormat(undefined, {
                        dateStyle: 'medium',
                        timeStyle: 'short',
                        timeZone: userTimeZone
                    }).format(d);
                } catch {
                    return d.toLocaleString();
                }
            }
        }

        function pickDueDate(obj, opts = {}) {
            const includePosted = !!opts.includePosted;
            const includeCreated = !!opts.includeCreated;
            return obj?.due_date
                || obj?.all_day_date
                || obj?.due_at
                || obj?.plannable_date
                || obj?.start_at
                || obj?.end_at
                || (includePosted ? obj?.posted_at : null)
                || (includeCreated ? obj?.created_at : null)
                || null;
        }

        function getItemDate(raw, opts = {}) {
            const picked = pickDueDate(raw, opts);
            return parseCanvasDate(picked);
        }

        function passesQuickFilter(dateObj) {
            if (quickFilter === 'all') return true;
            if (!dateObj || Number.isNaN(dateObj.getTime())) return false;
            const now = Date.now();
            const delta = dateObj.getTime() - now;
            if (quickFilter === 'overdue') return delta < 0;
            if (quickFilter === 'next48h') return delta >= 0 && delta <= (48 * 60 * 60 * 1000);
            if (quickFilter === 'week') return delta >= 0 && delta <= (7 * 24 * 60 * 60 * 1000);
            return true;
        }

        function askBlueprint(text) {
            const q = String(text || '').trim();
            if (!q) return;
            window.location.href = `index.html?prompt=${encodeURIComponent(q)}`;
        }
        function askBlueprintEncoded(encoded) {
            try {
                askBlueprint(decodeURIComponent(String(encoded || '')));
            } catch (e) {
                setStatus('Unable to open Chat action. Please try again.', 'error');
            }
        }

        function getCanvasOrigin() {
            if (currentCanvasOrigin) return currentCanvasOrigin;
            const candidates = [
                currentCanvasData?.canvas_url,
                currentCanvasData?.canvasUrl,
                sessionStorage.getItem('lastCanvasUrl')
            ];
            for (const candidate of candidates) {
                try {
                    const value = String(candidate || '').trim();
                    if (!value) continue;
                    const u = new URL(value.startsWith('http') ? value : `https://${value}`);
                    currentCanvasOrigin = `${u.protocol}//${u.host}`;
                    return currentCanvasOrigin;
                } catch {}
            }
            return '';
        }

        function resolveCanvasLink(raw) {
            const value = String(raw || '').trim();
            if (!value) return '';
            try {
                const u = new URL(value, getCanvasOrigin() || window.location.origin);
                u.pathname = u.pathname.replace('/api/v1/', '/');
                u.search = '';
                return u.toString();
            } catch {
                return '';
            }
        }

        function getCanvasAssignmentLink(a) {
            if (!a || typeof a !== 'object') return '';
            const direct = String(a?.html_url || '').trim();
            if (direct) return resolveCanvasLink(direct);

            const apiUrl = String(a?.url || '').trim();
            if (apiUrl) return resolveCanvasLink(apiUrl);

            const courseId = a?.course_id;
            const assignmentId = a?.id;
            if (courseId && assignmentId) {
                const base = getCanvasOrigin();
                const path = `/courses/${encodeURIComponent(courseId)}/assignments/${encodeURIComponent(assignmentId)}`;
                return base ? `${base}${path}` : path;
            }
            return '';
        }

        function getCanvasInboxLink(m) {
            if (!m || typeof m !== 'object') return '';
            const direct = String(m?.html_url || '').trim();
            if (direct) return resolveCanvasLink(direct);

            const raw = String(m?.url || '').trim();
            if (raw) return resolveCanvasLink(raw);

            if (m?.id) {
                const base = getCanvasOrigin();
                const path = `/conversations/${encodeURIComponent(m.id)}`;
                return base ? `${base}${path}` : path;
            }
            return '';
        }

        function getCanvasGenericLink(item) {
            if (!item || typeof item !== 'object') return '';
            const direct = String(item?.html_url || '').trim();
            if (direct) return resolveCanvasLink(direct);
            const raw = String(item?.url || '').trim();
            return resolveCanvasLink(raw);
        }

        function stripHtmlToText(html) {
            const raw = String(html || '').trim();
            if (!raw) return '';
            try {
                const doc = new DOMParser().parseFromString(raw, 'text/html');
                return (doc.body?.textContent || '').replace(/\s+/g, ' ').trim();
            } catch {
                return raw.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            }
        }

        function getCourseKey(raw) {
            if (!raw) return '';
            const id = raw.course_id ?? raw?.plannable?.course_id ?? raw?.assignment?.course_id ?? raw?.context_id;
            if (id !== undefined && id !== null && String(id) !== '') return `id:${id}`;
            const code = raw.course_code || raw.context_code || raw?.plannable?.context_code || raw.course_name || raw.context_name;
            if (code) return `code:${String(code).toLowerCase()}`;
            return '';
        }

        function isCourseMatch(raw) {
            if (selectedCourse === '__all__') return true;
            return getCourseKey(raw) === selectedCourse;
        }

        function buildCourseFilter(data) {
            const select = document.getElementById('courseFilter');
            if (!select) return;

            const map = new Map();
            const add = (key, label) => {
                if (!key || !label) return;
                if (!map.has(key)) map.set(key, label);
            };

            const courses = Array.isArray(data.courses) ? data.courses : [];
            for (const c of courses) {
                const key = c?.id !== undefined ? `id:${c.id}` : (c?.course_code ? `code:${String(c.course_code).toLowerCase()}` : '');
                add(key, c?.name || c?.course_code || `Course ${c?.id || ''}`);
            }

            const inject = (arr) => {
                for (const i of Array.isArray(arr) ? arr : []) {
                    const key = getCourseKey(i);
                    const label = i?.course_name || i?.course_code || i?.context_name || i?.context_code || '';
                    add(key, label);
                }
            };
            inject(data.assignments);
            inject(data.grades);
            inject(data.planner_items);
            inject(data.calendar_events);
            inject(data.announcements);
            inject(data.modules);
            inject(data.submissions);
            inject(data.discussion_topics);
            inject(data.syllabi);

            const options = [`<option value="__all__">All courses</option>`]
                .concat(
                    Array.from(map.entries())
                        .sort((a, b) => a[1].localeCompare(b[1]))
                        .map(([key, label]) => `<option value="${esc(key)}">${esc(label)}</option>`)
                );
            select.innerHTML = options.join('');
            if (!map.has(selectedCourse)) selectedCourse = '__all__';
            select.value = selectedCourse;
        }

        function onCourseFilterChange(value) {
            selectedCourse = value || '__all__';
            if (!currentCanvasData) return;
            renderDashboard(currentCanvasData);
        }

        function onDashboardSearch(value) {
            dashboardSearch = String(value || '').trim().toLowerCase();
            if (!currentCanvasData) return;
            renderDashboard(currentCanvasData);
        }

        function toggleUpcomingExpanded() {
            upcomingExpanded = !upcomingExpanded;
            if (currentCanvasData) renderDashboard(currentCanvasData);
        }
        function toggleInboxExpanded() {
            inboxExpanded = !inboxExpanded;
            if (currentCanvasData) renderDashboard(currentCanvasData);
        }
        function toggleQuickActionsExpanded() {
            quickActionsExpanded = !quickActionsExpanded;
            if (currentCanvasData) renderDashboard(currentCanvasData);
        }

        function matchesSearch(...vals) {
            if (!dashboardSearch) return true;
            const text = vals.map((v) => String(v || '').toLowerCase()).join(' ');
            return text.includes(dashboardSearch);
        }

        function isSubmissionComplete(submission) {
            if (!submission || typeof submission !== 'object') return false;
            if (submission.bp_completed === true) return true;
            const score = submission?.score;
            if (score !== null && score !== undefined && Number.isFinite(Number(score))) return true;
            if (String(submission?.grade || '').trim()) return true;
            if (submission?.submitted_at || submission?.graded_at) return true;
            const state = String(submission?.workflow_state || submission?.state || '').toLowerCase();
            return ['graded', 'submitted', 'complete', 'completed'].includes(state);
        }

        function buildCompletedAssignmentSet(submissions) {
            const set = new Set();
            for (const s of Array.isArray(submissions) ? submissions : []) {
                if (!isSubmissionComplete(s)) continue;
                const assignmentId = s?.assignment_id ?? s?.id;
                if (assignmentId === null || assignmentId === undefined || assignmentId === '') continue;
                set.add(String(assignmentId));
            }
            return set;
        }

        function isAssignmentComplete(assignment, completedSet) {
            if (!assignment || !completedSet || completedSet.size === 0) return false;
            const assignmentId = assignment?.id;
            if (assignmentId === null || assignmentId === undefined || assignmentId === '') return false;
            return completedSet.has(String(assignmentId));
        }

        function normalizeUpcoming(assignments, completedSet = new Set()) {
            const list = Array.isArray(assignments) ? assignments : [];
            const upcoming = list
                .filter(a => a && isCourseMatch(a))
                .filter(a => !isAssignmentComplete(a, completedSet))
                .filter(a => matchesSearch(a?.name, a?.course_name, a?.course_code))
                .map((a) => ({ raw: a, due: getItemDate(a) }))
                .filter((x) => x.due && (quickFilter === 'overdue' ? x.due.getTime() < Date.now() : x.due.getTime() > Date.now()))
                .filter((x) => passesQuickFilter(x.due))
                .sort((a, b) => a.due - b.due)
                .slice(0, 20);

            return upcoming.map((x) => x.raw);
        }

        function renderUpcoming(assignments, completedSet = new Set()) {
            const container = document.getElementById('upcomingAssignments');
            const upcoming = normalizeUpcoming(assignments, completedSet);

            if (!upcoming.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No upcoming assignments found.</div>';
                return;
            }

            const visible = upcomingExpanded ? upcoming : upcoming.slice(0, 3);
            const rows = visible.map(a => {
                const due = getItemDate(a);
                if (!due) return '';
                const days = Math.ceil((due - new Date()) / (1000 * 60 * 60 * 24));
                const badge = days <= 2 ? 'Soon' : days <= 7 ? 'This week' : 'Later';
                const color = days <= 2 ? 'rgba(255,59,106,0.95)' : days <= 7 ? 'rgba(255,196,0,0.95)' : 'rgba(23,105,255,0.92)';
                const askPrompt = encodeURIComponent(`Help me plan ${a.name || 'this assignment'} in ${a.course_name || 'my course'}.`);
                const link = getCanvasAssignmentLink(a);
                const openCanvasBtn = link
                    ? `<a class="btn" style="padding: 6px 10px;" href="${esc(link)}" target="_blank" rel="noopener noreferrer">Open in Canvas</a>`
                    : '';
                return `
                    <div class="item">
                        <div class="item-title">${esc(a.name || 'Untitled')}</div>
                        <div class="item-meta">${esc(a.course_name || a.course_code || '')} â€¢ <span style="color:${color}; font-weight: 950;">${badge}</span></div>
                        <div class="item-when">Due: ${esc(formatWhen(due))}</div>
                        <div style="margin-top: 8px; display:flex; gap:8px; flex-wrap:wrap;">
                            ${openCanvasBtn}
                            <button class="btn" type="button" style="padding: 6px 10px;" onclick="askBlueprintEncoded('${askPrompt}')">Ask Blueprint</button>
                        </div>
                    </div>
                `;
            }).join('');
            const more = upcoming.length > 3
                ? `<button class="btn" type="button" style="padding:6px 10px;" onclick="toggleUpcomingExpanded()">${upcomingExpanded ? 'Show less' : `Show more (${upcoming.length - 3})`}</button>`
                : '';
            container.innerHTML = `${rows}${more ? `<div style="margin-top:8px;">${more}</div>` : ''}`;
        }

        function renderGrades(grades) {
            const container = document.getElementById('gradesList');
            const list = Array.isArray(grades) ? grades : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No grade data found.</div>';
                return;
            }

            container.innerHTML = list
                .filter(g => g && g.course_name && isCourseMatch(g))
                .filter(g => matchesSearch(g?.course_name, g?.current_grade, g?.current_score))
                .sort((a, b) => String(a.course_name).localeCompare(String(b.course_name)))
                .map(g => {
                    const score = (g.current_score === null || g.current_score === undefined) ? '' : ` (${g.current_score}%)`;
                    const gradeText = esc(g.current_grade || 'N/A');
                    return `
                        <div class="item">
                            <div class="item-title">${esc(g.course_name)}</div>
                            <div class="item-meta">Current grade: <strong>${gradeText}</strong>${esc(score)}</div>
                        </div>
                    `;
                }).join('');
        }

        function renderPlanner(items) {
            const container = document.getElementById('plannerList');
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No planner items found.</div>';
                return;
            }

            const normalized = list
                .map(i => {
                    const dt = pickDueDate(i);
                    const d = parseCanvasDate(dt);
                    return { raw: i, t: d ? d.getTime() : 0 };
                })
                .filter(({ raw }) => isCourseMatch(raw))
                .filter(({ raw }) => matchesSearch(raw?.plannable?.title, raw?.plannable?.name, raw?.title, raw?.context_name, raw?.context_code))
                .filter(({ t }) => passesQuickFilter(t ? new Date(t) : null))
                .sort((a, b) => a.t - b.t)
                .slice(0, 200);

            container.innerHTML = normalized.map(({ raw, t }) => {
                const title = raw?.plannable?.title || raw?.plannable?.name || raw?.title || 'Planner item';
                const course = raw?.context_name || raw?.context_code || raw?.context_type || '';
                const when = t ? formatWhen(t) : 'No date';
                const askPrompt = encodeURIComponent(`What should I do first for ${title}?`);
                return `
                    <div class="item">
                        <div class="item-title">${esc(title)}</div>
                        <div class="item-meta">${esc(course)}</div>
                        <div class="item-when">${esc(when)}</div>
                        <div style="margin-top: 8px;">
                            <button class="btn" type="button" style="padding: 6px 10px;" onclick="askBlueprintEncoded('${askPrompt}')">Ask Blueprint</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCalendar(events) {
            const container = document.getElementById('calendarList');
            const list = Array.isArray(events) ? events : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No calendar events found.</div>';
                return;
            }

            const normalized = list
                .map(e => {
                    const dt = pickDueDate(e);
                    const d = parseCanvasDate(dt);
                    return { raw: e, t: d ? d.getTime() : 0 };
                })
                .filter(({ raw }) => isCourseMatch(raw))
                .filter(({ raw }) => matchesSearch(raw?.title, raw?.summary, raw?.context_name, raw?.context_code))
                .filter(({ t }) => passesQuickFilter(t ? new Date(t) : null))
                .sort((a, b) => a.t - b.t)
                .slice(0, 200);

            container.innerHTML = normalized.map(({ raw, t }) => {
                const title = raw?.title || raw?.summary || 'Event';
                const context = raw?.context_name || raw?.context_code || '';
                const when = t ? formatWhen(t) : 'No date';
                return `
                    <div class="item">
                        <div class="item-title">${esc(title)}</div>
                        <div class="item-meta">${esc(context)}</div>
                        <div class="item-when">${esc(when)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderAnnouncements(items) {
            const container = document.getElementById('announcementsList');
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No announcements found.</div>';
                return;
            }

            const normalized = list
                .map(a => {
                    const dt = pickDueDate(a, { includePosted: true, includeCreated: true });
                    const d = parseCanvasDate(dt);
                    return { raw: a, t: d ? d.getTime() : 0 };
                })
                .filter(({ raw }) => isCourseMatch(raw))
                .filter(({ raw }) => matchesSearch(raw?.title, raw?.context_name, raw?.context_code))
                .sort((a, b) => b.t - a.t)
                .slice(0, 100);

            container.innerHTML = normalized.map(({ raw, t }) => {
                const title = raw?.title || 'Announcement';
                const context = raw?.context_name || raw?.context_code || '';
                const when = t ? formatWhen(t) : '';
                const link = raw?.html_url || raw?.url || '';
                const linkHtml = link ? `<a class="btn" style="padding: 6px 10px;" href="${esc(link)}" target="_blank" rel="noopener noreferrer">Open</a>` : '';
                return `
                    <div class="item">
                        <div class="item-title">${esc(title)}</div>
                        <div class="item-meta">${esc(context)}${when ? ` â€¢ ${esc(when)}` : ''}</div>
                        <div style="margin-top: 8px;">${linkHtml}</div>
                    </div>
                `;
            }).join('');
        }

        function looksInstructorAuthored(raw) {
            const roleText = [
                raw?.author_role,
                raw?.author?.role,
                raw?.author?.enrollment_type,
                raw?.user?.role,
                raw?.user?.enrollment_type,
                raw?.author?.type
            ].map((x) => String(x || '').toLowerCase()).join(' ');
            if (/(teacher|instructor|ta|admin|professor|faculty)/i.test(roleText)) return true;

            const titleText = [
                raw?.title,
                raw?.subject,
                raw?.context_name,
                raw?.course_name
            ].map((x) => String(x || '').toLowerCase()).join(' ');
            if (/announcement/i.test(titleText)) return true;
            return false;
        }

        function renderInbox(announcements, inboxMessages) {
            const container = document.getElementById('inboxList');
            if (!container) return;

            const ann = (Array.isArray(announcements) ? announcements : [])
                .map((a) => ({
                    raw: a,
                    type: 'Announcement',
                    title: a?.title || 'Announcement',
                    context: a?.context_name || a?.context_code || a?.course_name || a?.course_code || '',
                    when: parseCanvasDate(a?.posted_at || a?.created_at || a?.updated_at),
                    link: a?.html_url || a?.url || ''
                }));

            const inbox = (Array.isArray(inboxMessages) ? inboxMessages : [])
                .map((m) => ({
                    raw: m,
                    type: 'Inbox',
                    title: m?.subject || 'Inbox message',
                    context: m?.context_name || m?.context_code || '',
                    when: parseCanvasDate(m?.last_message_at || m?.updated_at),
                    link: getCanvasInboxLink(m)
                }));

            const merged = ann.concat(inbox)
                .filter((m) => isCourseMatch(m.raw))
                .filter((m) => matchesSearch(m.title, m.context, m.type))
                .filter((m) => m.when)
                .sort((a, b) => b.when - a.when);

            const instructorOnly = merged.filter((m) => looksInstructorAuthored(m.raw));
            const selected = (instructorOnly.length ? instructorOnly : merged).slice(0, 120);

            if (!selected.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No instructor messages found yet. Sync Canvas again after new inbox or announcement activity.</div>';
                return;
            }

            const visible = inboxExpanded ? selected : selected.slice(0, 6);
            const rows = visible.map((m) => {
                const linkHtml = m.link
                    ? `<a class="btn" style="padding: 6px 10px;" href="${esc(m.link)}" target="_blank" rel="noopener noreferrer">Open</a>`
                    : '';
                return `
                    <div class="item">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                            <div class="item-title">${esc(m.title)}</div>
                            <span class="focus-tag">${esc(m.type)}</span>
                        </div>
                        <div class="item-meta">${esc(m.context || 'Canvas')} â€¢ ${esc(formatWhen(m.when))}</div>
                        <div style="margin-top: 8px;">${linkHtml}</div>
                    </div>
                `;
            }).join('');
            const more = selected.length > 6
                ? `<button class="btn" type="button" style="padding:6px 10px;" onclick="toggleInboxExpanded()">${inboxExpanded ? 'Show less' : `Show more (${selected.length - 6})`}</button>`
                : '';
            container.innerHTML = `${rows}${more ? `<div style="margin-top:8px;">${more}</div>` : ''}`;
        }

        function renderModules(items) {
            const container = document.getElementById('modulesList');
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No modules found.</div>';
                return;
            }
            const filtered = list.filter((m) => isCourseMatch(m) && matchesSearch(m?.name, m?.course_name, m?.course_code));
            const grouped = new Map();
            for (const m of filtered) {
                const course = m?.course_name || m?.course_code || m?.context_name || 'Other';
                if (!grouped.has(course)) grouped.set(course, []);
                grouped.get(course).push(m);
            }
            const blocks = Array.from(grouped.entries())
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([course, mods]) => {
                    const rows = mods
                        .sort((a, b) => (a?.position ?? 9999) - (b?.position ?? 9999))
                        .slice(0, 80)
                        .map((m) => {
                            const name = m?.name || 'Module';
                            const itemCount = Array.isArray(m?.items) ? m.items.length : 0;
                            const unlockAt = m?.unlock_at ? ` â€¢ Unlocks ${formatWhen(m.unlock_at)}` : '';
                            return `<div class="item"><div class="item-title">${esc(name)}</div><div class="item-meta">${itemCount} items${esc(unlockAt)}</div></div>`;
                        }).join('');
                    return `<div class="item" style="display:block;"><div class="item-title">${esc(course)} (${mods.length})</div></div>${rows}`;
                }).join('');
            container.innerHTML = blocks || '<div class="muted" style="padding: 10px;">No modules found for this course.</div>';
        }

        function renderSubmissions(items) {
            const container = document.getElementById('submissionsList');
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No submissions found.</div>';
                return;
            }
            const normalized = list
                .map((s) => {
                    const dt = s?.submitted_at || s?.graded_at || s?.updated_at || s?.created_at || null;
                    const d = parseCanvasDate(dt);
                    return { raw: s, t: d ? d.getTime() : 0 };
                })
                .filter(({ raw }) => isCourseMatch(raw))
                .filter(({ raw }) => matchesSearch(raw?.assignment_name, raw?.assignment?.name, raw?.course_name, raw?.course_code, raw?.grade, raw?.workflow_state))
                .sort((a, b) => b.t - a.t)
                .slice(0, 300);

            container.innerHTML = normalized.map(({ raw, t }) => {
                const name = raw?.assignment_name || raw?.assignment?.name || raw?.cached_assignment_name || `Assignment #${raw?.assignment_id || ''}`;
                const course = raw?.course_name || raw?.course_code || '';
                const state = raw?.workflow_state ? ` (${raw.workflow_state})` : '';
                const score = raw?.score !== undefined && raw?.score !== null ? `${raw.score}${raw?.grade ? ` (${raw.grade})` : ''}` : (raw?.grade || `Not graded${state}`);
                const when = t ? formatWhen(t) : 'No timestamp';
                return `
                    <div class="item">
                        <div class="item-title">${esc(name)}</div>
                        <div class="item-meta">${esc(course)} â€¢ Score: ${esc(score)}</div>
                        <div class="item-when">${esc(when)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderDiscussions(items) {
            const container = document.getElementById('discussionsList');
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No discussions found.</div>';
                return;
            }
            const normalized = list
                .map((d) => {
                    const dt = pickDueDate(d, { includePosted: true, includeCreated: true });
                    const parsed = parseCanvasDate(dt);
                    return { raw: d, t: parsed ? parsed.getTime() : 0 };
                })
                .filter(({ raw }) => isCourseMatch(raw))
                .filter(({ raw }) => matchesSearch(raw?.title, raw?.course_name, raw?.course_code, raw?.context_code))
                .sort((a, b) => b.t - a.t)
                .slice(0, 250);

            container.innerHTML = normalized.map(({ raw, t }) => {
                const title = raw?.title || 'Discussion topic';
                const course = raw?.course_name || raw?.course_code || raw?.context_code || '';
                const count = Number.isFinite(raw?.discussion_subentry_count) ? `${raw.discussion_subentry_count} replies` : '';
                const when = t ? formatWhen(t) : '';
                const link = raw?.html_url || raw?.url || '';
                const linkHtml = link ? `<a class="btn" style="padding: 6px 10px;" href="${esc(link)}" target="_blank" rel="noopener noreferrer">Open</a>` : '';
                return `
                    <div class="item">
                        <div class="item-title">${esc(title)}</div>
                        <div class="item-meta">${esc(course)}${count ? ` â€¢ ${esc(count)}` : ''}${when ? ` â€¢ ${esc(when)}` : ''}</div>
                        <div style="margin-top: 8px;">${linkHtml}</div>
                    </div>
                `;
            }).join('');
        }

        function renderSyllabi(items) {
            const container = document.getElementById('syllabiList');
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                container.innerHTML = '<div class="muted" style="padding: 10px;">No syllabi found.</div>';
                return;
            }
            container.innerHTML = list
                .filter((s) => isCourseMatch(s))
                .filter((s) => matchesSearch(s?.course_name, s?.course_code, stripHtmlToText(s?.syllabus_body || '')))
                .slice(0, 120).map((s) => {
                const course = s?.course_name || s?.course_code || `Course ${s?.course_id || ''}`;
                const body = stripHtmlToText(s?.syllabus_body || '');
                const preview = body ? body.slice(0, 260) : 'No syllabus body available for this course.';
                return `
                    <div class="item">
                        <div class="item-title">${esc(course)}</div>
                        <div class="item-meta">${esc(preview)}${body.length > 260 ? 'â€¦' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function renderPriorityQueue(assignments, planner, calendar, completedSet = new Set()) {
            const container = document.getElementById('priorityQueue');
            if (!container) return;

            const now = Date.now();
            const items = [];

            for (const a of assignments) {
                if (!a || !isCourseMatch(a) || !matchesSearch(a?.name, a?.course_name, a?.course_code)) continue;
                if (isAssignmentComplete(a, completedSet)) continue;
                const d = getItemDate(a);
                if (!d) continue;
                if (!passesQuickFilter(d)) continue;
                items.push({
                    title: a?.name || 'Assignment',
                    course: a?.course_name || a?.course_code || '',
                    when: d,
                    tag: 'Assignment',
                    link: getCanvasAssignmentLink(a)
                });
            }
            for (const p of planner) {
                if (!p || !isCourseMatch(p) || !matchesSearch(p?.title, p?.plannable?.title, p?.context_name, p?.context_code)) continue;
                const d = parseCanvasDate(pickDueDate(p));
                if (!d) continue;
                if (!passesQuickFilter(d)) continue;
                items.push({
                    title: p?.plannable?.title || p?.plannable?.name || p?.title || 'Planner item',
                    course: p?.context_name || p?.context_code || '',
                    when: d,
                    tag: 'Planner'
                });
            }
            for (const e of calendar) {
                if (!e || !isCourseMatch(e) || !matchesSearch(e?.title, e?.summary, e?.context_name, e?.context_code)) continue;
                const d = parseCanvasDate(pickDueDate(e));
                if (!d) continue;
                if (!passesQuickFilter(d)) continue;
                items.push({
                    title: e?.title || e?.summary || 'Calendar event',
                    course: e?.context_name || e?.context_code || '',
                    when: d,
                    tag: 'Calendar'
                });
            }

            const upcoming = items
                .filter((i) => i.when.getTime() >= now - (24 * 60 * 60 * 1000))
                .sort((a, b) => a.when - b.when)
                .slice(0, 3);

            if (!upcoming.length) {
                container.innerHTML = '<div class="muted">No urgent items match your current filter.</div>';
                return;
            }

            const valid = upcoming
                .map((i) => {
                    const title = String(i?.title || '').trim() || `${i?.tag || 'Task'}`;
                    const whenText = formatWhen(i?.when);
                    if (!whenText) return null;
                    return { ...i, title, whenText };
                })
                .filter(Boolean);

            if (!valid.length) {
                container.innerHTML = '<div class="muted">No urgent items match your current filter.</div>';
                return;
            }

            container.innerHTML = valid.map((i) => {
                const hoursAway = Math.round((i.when.getTime() - now) / (1000 * 60 * 60));
                const urgency = hoursAway <= 24 ? 'Do this first' : hoursAway <= 72 ? 'Do next' : 'Upcoming';
                const openBtn = i.link ? `<a class="btn" style="padding:6px 10px;" href="${esc(i.link)}" target="_blank" rel="noopener noreferrer">Open in Canvas</a>` : '';
                return `
                    <div class="focus-item">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                            <div class="focus-title">${esc(i.title)}</div>
                            <span class="focus-tag">${esc(i.tag)}</span>
                        </div>
                        <div class="focus-meta">${esc(i.course || 'Course')} â€¢ ${esc(i.whenText)} â€¢ ${esc(urgency)}</div>
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">${openBtn}</div>
                    </div>
                `;
            }).join('');
        }

        function renderQuickActions(grades, assignments, planner, calendar, announcements, completedSet = new Set()) {
            const container = document.getElementById('quickActions');
            if (!container) return;

            const actions = [];
            const now = Date.now();
            const gradeList = (Array.isArray(grades) ? grades : []).filter((g) => isCourseMatch(g));
            const assignmentList = (Array.isArray(assignments) ? assignments : [])
                .filter((a) => isCourseMatch(a))
                .filter((a) => !isAssignmentComplete(a, completedSet));
            const plannerList = (Array.isArray(planner) ? planner : []).filter((p) => isCourseMatch(p));
            const calendarList = (Array.isArray(calendar) ? calendar : []).filter((e) => isCourseMatch(e));
            const annList = (Array.isArray(announcements) ? announcements : []).filter((a) => isCourseMatch(a));

            const lowGrades = gradeList.filter((g) => {
                const score = Number(g?.current_score);
                return Number.isFinite(score) && score < 75;
            });
            for (const g of lowGrades.slice(0, 3)) {
                const prompt = `Create a 7-day recovery plan for ${g.course_name || 'this course'} using concrete tasks tied to upcoming deadlines. Current score: ${g.current_score}%${g.current_grade ? ` (${g.current_grade})` : ''}.`;
                actions.push({
                    title: `Recover ${g.course_name || 'course'} this week`,
                    meta: `Current score ${g.current_score}%${g.current_grade ? ` (${g.current_grade})` : ''}. Ask Blueprint Chat for a 7-day catch-up plan.`,
                    prompt
                });
            }

            const urgentWork = []
                .concat(
                    assignmentList.map((a) => ({ title: a?.name || 'Assignment', when: parseCanvasDate(a?.due_at), course: a?.course_name || a?.course_code || '', type: 'Assignment' })),
                    plannerList.map((p) => ({ title: p?.plannable?.title || p?.plannable?.name || p?.title || 'Planner item', when: parseCanvasDate(pickDueDate(p)), course: p?.context_name || p?.context_code || '', type: 'Planner' })),
                    calendarList.map((e) => ({ title: e?.title || e?.summary || 'Calendar event', when: parseCanvasDate(pickDueDate(e)), course: e?.context_name || e?.context_code || '', type: 'Calendar' }))
                )
                .filter((x) => x.when && (x.when.getTime() - now) <= (48 * 60 * 60 * 1000) && (x.when.getTime() - now) >= -(24 * 60 * 60 * 1000))
                .sort((a, b) => a.when - b.when);
            if (urgentWork.length) {
                const first = urgentWork[0];
                const prompt = `Give me a do-now action list for ${first.title} in ${first.course || 'this course'} due ${formatWhen(first.when)}. Include exact next steps for the next 30 minutes.`;
                actions.push({
                    title: `Handle ${urgentWork.length} urgent item${urgentWork.length > 1 ? 's' : ''} in next 48h`,
                    meta: `${first.title} (${first.type}) is first. Open ${first.course || 'that course'} now.`,
                    prompt
                });
            }

            const recentAnnouncements = annList.filter((a) => {
                const d = parseCanvasDate(a?.posted_at || a?.created_at);
                return d && (Date.now() - d.getTime()) <= 7 * 24 * 60 * 60 * 1000;
            });
            if (recentAnnouncements.length) {
                const latest = recentAnnouncements[0];
                actions.push({
                    title: `Review ${recentAnnouncements.length} recent announcement${recentAnnouncements.length > 1 ? 's' : ''}`,
                    meta: 'Check for due-date changes or exam logistics and update your study plan.',
                    prompt: `Summarize this announcement and create an action list: ${latest?.title || 'Recent announcement'}.`
                });
            }

            const filtered = actions.filter((r) => matchesSearch(r.title, r.meta)).slice(0, 8);
            const clean = filtered
                .map((r) => ({
                    title: String(r?.title || '').trim(),
                    meta: String(r?.meta || '').trim()
                }))
                .filter((r) => r.title || r.meta);

            if (!clean.length) {
                container.innerHTML = '<div class="muted">No immediate actions. You look caught up for current filters.</div>';
                return;
            }

            const visible = quickActionsExpanded ? clean : clean.slice(0, 4);
            const rows = visible.map((r) => {
                const encodedPrompt = encodeURIComponent(String(r.prompt || `Turn this into a concrete action list: ${r.title}. ${r.meta || ''}`));
                return `
                <div class="focus-item">
                    <div class="focus-title">${esc(r.title || 'Suggested action')}</div>
                    <div class="focus-meta">${esc(r.meta || 'Open chat for a tailored next-step plan.')}</div>
                    <div style="margin-top:8px;">
                        <button class="btn" type="button" style="padding:6px 10px;" onclick="askBlueprintEncoded('${encodedPrompt}')">Create Action List</button>
                    </div>
                </div>
            `;
            }).join('');
            const more = clean.length > 4
                ? `<button class="btn" type="button" style="padding:6px 10px;" onclick="toggleQuickActionsExpanded()">${quickActionsExpanded ? 'Show less' : `Show more (${clean.length - 4})`}</button>`
                : '';
            container.innerHTML = `${rows}${more ? `<div style="margin-top:8px;">${more}</div>` : ''}`;
        }

        function renderCommandQueue(assignments, planner, calendar, completedSet = new Set()) {
            const container = document.getElementById('commandQueue');
            if (!container) return;
            const now = Date.now();
            const rows = [];

            for (const a of assignments || []) {
                if (!a || !isCourseMatch(a) || !matchesSearch(a?.name, a?.course_name, a?.course_code)) continue;
                if (isAssignmentComplete(a, completedSet)) continue;
                const when = getItemDate(a);
                if (!when || !passesQuickFilter(when)) continue;
                rows.push({
                    type: 'Assignment',
                    title: a?.name || 'Assignment',
                    course: a?.course_name || a?.course_code || '',
                    when,
                    link: getCanvasAssignmentLink(a),
                    prompt: `Give me a concrete do-now checklist for ${a?.name || 'this assignment'} in ${a?.course_name || 'my course'}. Due: ${formatWhen(when)}. If possible, include exact submission requirements and a 30-minute first sprint.`
                });
            }
            for (const p of planner || []) {
                if (!p || !isCourseMatch(p) || !matchesSearch(p?.title, p?.plannable?.title, p?.context_name)) continue;
                const when = parseCanvasDate(pickDueDate(p));
                if (!when || !passesQuickFilter(when)) continue;
                const title = p?.plannable?.title || p?.plannable?.name || p?.title || 'Planner item';
                rows.push({
                    type: 'Planner',
                    title,
                    course: p?.context_name || p?.context_code || '',
                    when,
                    link: getCanvasGenericLink(p),
                    prompt: `Break ${title} (${p?.context_name || p?.context_code || 'course'}) into a precise do-now sequence with timestamps for the next 60 minutes.`
                });
            }
            for (const e of calendar || []) {
                if (!e || !isCourseMatch(e) || !matchesSearch(e?.title, e?.summary, e?.context_name)) continue;
                const when = parseCanvasDate(pickDueDate(e));
                if (!when || !passesQuickFilter(when)) continue;
                const title = e?.title || e?.summary || 'Calendar event';
                rows.push({
                    type: 'Calendar',
                    title,
                    course: e?.context_name || e?.context_code || '',
                    when,
                    link: getCanvasGenericLink(e),
                    prompt: `How should I prepare for ${title} by ${formatWhen(when)}? Give concrete actions and what to open first in Canvas.`
                });
            }

            const selected = rows
                .filter((r) => r.when.getTime() >= now - (24 * 60 * 60 * 1000))
                .sort((a, b) => a.when - b.when)
                .slice(0, 10);

            if (!selected.length) {
                container.innerHTML = '<div class="muted">No immediate tasks for current filters.</div>';
                return;
            }

            container.innerHTML = selected.map((r) => {
                const hours = Math.round((r.when.getTime() - now) / (1000 * 60 * 60));
                const risk = hours < 0 ? 'Overdue' : hours <= 24 ? 'Now' : hours <= 72 ? 'Soon' : 'Later';
                const riskClass = risk === 'Overdue' || risk === 'Now' ? 'high' : (risk === 'Soon' ? 'medium' : 'low');
                const openBtn = r.link ? `<a class="btn" style="padding:6px 10px;" href="${esc(r.link)}" target="_blank" rel="noopener noreferrer">Open in Canvas</a>` : '';
                const encodedPrompt = encodeURIComponent(r.prompt || '');
                return `
                    <div class="focus-item">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                            <div class="focus-title">${esc(r.title)}</div>
                            <span class="risk-chip ${riskClass}">${esc(risk)}</span>
                        </div>
                        <div class="focus-meta">${esc(r.course || 'Course')} â€¢ ${esc(formatWhen(r.when))} â€¢ ${esc(r.type)}</div>
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" type="button" style="padding:6px 10px;" onclick="askBlueprintEncoded('${encodedPrompt}')">Do now</button>
                            ${openBtn}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderGradeWatch(grades, assignments, completedSet = new Set()) {
            const container = document.getElementById('gradeWatchList');
            if (!container) return;
            const byCourseWork = new Map();
            for (const a of assignments || []) {
                if (!isCourseMatch(a)) continue;
                if (isAssignmentComplete(a, completedSet)) continue;
                const c = a?.course_name || a?.course_code || 'Other';
                const due = getItemDate(a);
                const row = byCourseWork.get(c) || { upcoming: 0, overdue: 0 };
                if (due) {
                    if (due.getTime() < Date.now()) row.overdue += 1;
                    else if (due.getTime() < Date.now() + (7 * 24 * 60 * 60 * 1000)) row.upcoming += 1;
                }
                byCourseWork.set(c, row);
            }

            const rows = (grades || [])
                .filter((g) => isCourseMatch(g))
                .map((g) => {
                    const c = g?.course_name || g?.course_code || 'Course';
                    const score = Number(g?.current_score);
                    const work = byCourseWork.get(c) || { upcoming: 0, overdue: 0 };
                    const riskScore = (Number.isFinite(score) ? (score < 75 ? 35 : score < 85 ? 15 : 0) : 10) + (work.overdue * 25) + (work.upcoming * 5);
                    const risk = riskScore >= 45 ? 'High' : riskScore >= 20 ? 'Watch' : 'Stable';
                    return { course: c, score, work, risk, riskScore };
                })
                .sort((a, b) => b.riskScore - a.riskScore)
                .slice(0, 8);

            if (!rows.length) {
                container.innerHTML = '<div class="muted">No grade data available.</div>';
                return;
            }

            container.innerHTML = rows.map((r) => {
                const riskClass = r.risk === 'High' ? 'high' : (r.risk === 'Watch' ? 'medium' : 'low');
                const focus = Number.isFinite(r.score) && r.score >= 90 ? 'maintenance and smart pacing' : 'grade recovery and backlog reduction';
                const prompt = `Create a 7-day ${focus} plan for ${r.course}. Current score: ${Number.isFinite(r.score) ? r.score + '%' : 'unknown'}. Overdue: ${r.work.overdue}, due soon: ${r.work.upcoming}. Give day-by-day tasks with due-date priority.`;
                const encodedPrompt = encodeURIComponent(prompt);
                return `
                    <div class="focus-item">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                            <div class="focus-title">${esc(r.course)}</div>
                            <span class="risk-chip ${riskClass}">${esc(r.risk)}</span>
                        </div>
                        <div class="focus-meta">Score: ${esc(Number.isFinite(r.score) ? `${r.score}%` : 'N/A')} â€¢ Overdue: ${esc(r.work.overdue)} â€¢ Due soon: ${esc(r.work.upcoming)}</div>
                        <div style="margin-top:8px;">
                            <button class="btn" type="button" style="padding:6px 10px;" onclick="askBlueprintEncoded('${encodedPrompt}')">Recovery Plan</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMessageActions(announcements, inboxMessages) {
            const container = document.getElementById('messageActions');
            if (!container) return;
            const messages = [];

            for (const a of announcements || []) {
                if (!isCourseMatch(a)) continue;
                messages.push({
                    type: 'Announcement',
                    title: a?.title || 'Announcement',
                    context: a?.context_name || a?.context_code || '',
                    when: parseCanvasDate(a?.posted_at || a?.created_at || a?.updated_at),
                    link: getCanvasGenericLink(a)
                });
            }
            for (const m of inboxMessages || []) {
                if (!isCourseMatch(m)) continue;
                messages.push({
                    type: 'Inbox',
                    title: m?.subject || 'Inbox message',
                    context: m?.context_name || m?.context_code || '',
                    when: parseCanvasDate(m?.last_message_at || m?.updated_at),
                    link: getCanvasInboxLink(m)
                });
            }

            const selected = messages
                .filter((m) => m.when && matchesSearch(m.title, m.context, m.type))
                .sort((a, b) => b.when - a.when)
                .slice(0, 8);

            if (!selected.length) {
                container.innerHTML = '<div class="muted">No recent inbox/announcement actions right now.</div>';
                return;
            }

            container.innerHTML = selected.map((m) => {
                const openBtn = m.link ? `<a class="btn" style="padding:6px 10px;" href="${esc(m.link)}" target="_blank" rel="noopener noreferrer">Open</a>` : '';
                const prompt = `Summarize this ${m.type.toLowerCase()} and turn it into a concrete checklist with next actions, due dates, and what to open first in Canvas. Title: ${m.title}. Context: ${m.context || 'Canvas'}. Link: ${m.link || 'not available'}.`;
                const encodedPrompt = encodeURIComponent(prompt);
                return `
                    <div class="focus-item">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                            <div class="focus-title">${esc(m.title)}</div>
                            <span class="focus-tag">${esc(m.type)}</span>
                        </div>
                        <div class="focus-meta">${esc(m.context || 'Canvas')} â€¢ ${esc(formatWhen(m.when))}</div>
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                            ${openBtn}
                            <button class="btn" type="button" style="padding:6px 10px;" onclick="askBlueprintEncoded('${encodedPrompt}')">Create Action List</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buildWeeklyPlanData(data, completedSet = new Set()) {
            const assignments = Array.isArray(data.assignments)
                ? data.assignments.filter((a) => isCourseMatch(a)).filter((a) => !isAssignmentComplete(a, completedSet))
                : [];
            const planner = Array.isArray(data.planner_items) ? data.planner_items.filter((p) => isCourseMatch(p)) : [];
            const calendar = Array.isArray(data.calendar_events) ? data.calendar_events.filter((e) => isCourseMatch(e)) : [];
            const grades = Array.isArray(data.grades) ? data.grades.filter((g) => isCourseMatch(g)) : [];

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
                return { date: d, key: d.toDateString(), items: [] };
            });

            const addItem = (title, when, course, type) => {
                const dt = parseCanvasDate(when);
                if (!dt) return;
                const key = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()).toDateString();
                const day = days.find((x) => x.key === key);
                if (!day) return;
                day.items.push({ title: title || 'Task', course: course || '', type: type || 'Task', when: dt });
            };

            assignments.forEach((a) => addItem(a?.name, getItemDate(a), a?.course_name || a?.course_code, 'Assignment'));
            planner.forEach((p) => addItem(p?.plannable?.title || p?.title, pickDueDate(p), p?.context_name || p?.context_code, 'Planner'));
            calendar.forEach((e) => addItem(e?.title || e?.summary, pickDueDate(e), e?.context_name || e?.context_code, 'Calendar'));

            const lowGradeCourses = grades
                .filter((g) => Number.isFinite(Number(g?.current_score)) && Number(g.current_score) < 80)
                .map((g) => g?.course_name || g?.course_code)
                .filter(Boolean);

            for (const d of days) {
                d.items.sort((a, b) => a.when - b.when);
                if (lowGradeCourses.length && d.items.length < 2) {
                    d.items.push({
                        title: `Recovery block: ${lowGradeCourses[0]}`,
                        course: lowGradeCourses[0],
                        type: 'Grade Watch',
                        when: new Date(d.date.getTime() + 18 * 60 * 60 * 1000)
                    });
                }
            }

            return days;
        }

        function generateWeeklyPlan() {
            const container = document.getElementById('weeklyPlanList');
            if (!container) return;
            try {
                if (!currentCanvasData) {
                    container.innerHTML = '<div class="muted" style="padding:10px;">Sync Canvas data first.</div>';
                    setStatus('Sync Canvas data before generating a weekly plan.', 'warning');
                    return;
                }

                container.innerHTML = '<div class="muted" style="padding:10px;">Generating weekly plan...</div>';
                const completedSet = buildCompletedAssignmentSet(currentCanvasData?.submissions);
                const days = buildWeeklyPlanData(currentCanvasData, completedSet);
                weeklyPlanText = '';
                container.innerHTML = days.map((d) => {
                    const heading = d.date.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
                    const top = d.items.slice(0, 4);
                    const line = top.length
                        ? top.map((i) => `${i.type}: ${i.title}${i.course ? ` (${i.course})` : ''}`).join(' | ')
                        : 'Light day. Use for review, revision, and planning.';
                    weeklyPlanText += `${heading}: ${line}\n`;
                    return `<div class="planner-day"><h5>${esc(heading)}</h5><p>${esc(line)}</p></div>`;
                }).join('');
                setDashTab('weekly');
                setStatus('Weekly plan generated.', 'success');
                showToast('7-day plan ready');
            } catch (e) {
                container.innerHTML = '<div class="muted" style="padding:10px;">Could not generate plan. Try refreshing dashboard.</div>';
                setStatus(`Weekly plan error: ${e?.message || e}`, 'error');
            }
        }

        async function copyWeeklyPlan() {
            if (!weeklyPlanText) {
                generateWeeklyPlan();
            }
            if (!weeklyPlanText) return;
            try {
                await navigator.clipboard.writeText(weeklyPlanText.trim());
                setStatus('Weekly plan copied.', 'success');
                showToast('Weekly plan copied');
            } catch {
                setStatus('Unable to copy plan. You can still read it below.', 'warning');
            }
        }

        function updateTodaySnapshot(data, completedSet = new Set()) {
            const assignments = Array.isArray(data.assignments) ? data.assignments.filter((a) => isCourseMatch(a)) : [];
            const inbox = Array.isArray(data.inbox_messages) ? data.inbox_messages.filter((m) => isCourseMatch(m)) : [];
            let overdue = 0;
            let next48 = 0;
            const now = Date.now();
            for (const a of assignments) {
                if (isAssignmentComplete(a, completedSet)) continue;
                const d = getItemDate(a);
                if (!d) continue;
                const delta = d.getTime() - now;
                if (delta < 0) overdue += 1;
                if (delta >= 0 && delta <= 48 * 60 * 60 * 1000) next48 += 1;
            }
            const inboxNew = inbox.filter((m) => !!m?.unread).length;
            const set = (id, v) => {
                const el = document.getElementById(id);
                if (el) el.textContent = String(v);
            };
            set('snapOverdue', overdue);
            set('snap48h', next48);
            set('snapInbox', inboxNew);
        }
        function buildPulseSvg(counts, labels) {
            const max = Math.max(1, ...counts);
            return `<div class="heatmap">${
                counts.map((c, i) => {
                    const intensity = 0.10 + ((c / max) * 0.55);
                    return `
                        <div class="heatcell" style="background: rgba(23,105,255,${intensity.toFixed(2)});">
                            <div class="heatdate">${esc(labels[i] || '')}</div>
                            <div class="heatcount">${esc(c)}</div>
                        </div>
                    `;
                }).join('')
            }</div>`;
        }

        function buildDonutSvg(parts) {
            const size = 180;
            const r = 64;
            const cx = 90;
            const cy = 90;
            const total = Math.max(1, parts.reduce((a, p) => a + p.value, 0));

            let start = -Math.PI / 2;
            const arcs = parts.map((p, idx) => {
                const frac = p.value / total;
                const end = start + frac * Math.PI * 2;
                const x1 = cx + r * Math.cos(start);
                const y1 = cy + r * Math.sin(start);
                const x2 = cx + r * Math.cos(end);
                const y2 = cy + r * Math.sin(end);
                const large = frac > 0.5 ? 1 : 0;
                const path = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} Z`;

                const colors = [
                    'rgba(23,105,255,0.55)',
                    'rgba(74,163,255,0.45)',
                    'rgba(43,228,167,0.40)',
                    'rgba(255,196,0,0.40)',
                    'rgba(120,88,255,0.35)'
                ];
                const fill = colors[idx % colors.length];
                start = end;
                return `<path d="${path}" fill="${fill}" stroke="rgba(229,231,235,1)" stroke-width="1" />`;
            }).join('');

            const legend = parts.slice(0, 6).map((p, i) => {
                const colors = [
                    'rgba(23,105,255,0.55)',
                    'rgba(74,163,255,0.45)',
                    'rgba(43,228,167,0.40)',
                    'rgba(255,196,0,0.40)',
                    'rgba(120,88,255,0.35)'
                ];
                const fill = colors[i % colors.length];
                return `
                    <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
                        <span style="width:10px;height:10px;border-radius:999px;background:${fill};border:1px solid rgba(229,231,235,1);"></span>
                        <span class="muted" style="font-weight:900;">${esc(p.label)}:</span>
                        <span class="muted">${p.value}</span>
                    </div>
                `;
            }).join('');

            const svg = `
                <svg width="180" height="180" viewBox="0 0 ${size} ${size}">
                    <circle cx="${cx}" cy="${cy}" r="${r + 2}" fill="rgba(249,250,251,1)" stroke="rgba(229,231,235,1)" />
                    ${arcs}
                    <circle cx="${cx}" cy="${cy}" r="${r * 0.58}" fill="rgba(255,255,255,1)" stroke="rgba(229,231,235,1)" />
                    <text x="${cx}" y="${cy - 2}" text-anchor="middle" font-size="12" font-weight="900" fill="rgba(15,23,42,0.70)">Top courses</text>
                    <text x="${cx}" y="${cy + 18}" text-anchor="middle" font-size="18" font-weight="1000" fill="rgba(15,23,42,0.92)">${total}</text>
                </svg>
            `;

            return `<div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">${svg}<div>${legend}</div></div>`;
        }

        function buildVisuals(data) {
            const assignments = (Array.isArray(data.assignments) ? data.assignments : []).filter((a) => isCourseMatch(a));
            const planner = (Array.isArray(data.planner_items) ? data.planner_items : []).filter((p) => isCourseMatch(p));
            const calendar = (Array.isArray(data.calendar_events) ? data.calendar_events : []).filter((e) => isCourseMatch(e));

            // Workload heatmap (next 14 days) from assignments + planner + calendar
            const days = 14;
            const start = new Date();
            start.setHours(0,0,0,0);

            const counts = Array(days).fill(0);
            const labels = Array(days).fill('').map((_, i) => {
                const d = new Date(start.getTime() + i * 24 * 60 * 60 * 1000);
                return d.toLocaleDateString([], { month: 'numeric', day: 'numeric' });
            });

            const bump = (dt) => {
                if (!dt) return;
                const t = parseCanvasDate(dt);
                if (!t) return;
                const idx = Math.floor((t.getTime() - start.getTime()) / (24 * 60 * 60 * 1000));
                if (idx >= 0 && idx < days) counts[idx] += 1;
            };

            for (const a of assignments) bump(getItemDate(a));
            for (const p of planner) bump(pickDueDate(p));
            for (const e of calendar) bump(pickDueDate(e));

            const max = Math.max(1, ...counts);
            const busiestIdx = counts.indexOf(max);
            const busiestLabel = labels[busiestIdx] || '-';

            document.getElementById('pulseViz').innerHTML = buildPulseSvg(counts, labels);

            // Course mix
            const byCourse = new Map();
            for (const a of assignments) {
                const c = a?.course_name || a?.course_code || 'Other';
                byCourse.set(c, (byCourse.get(c) || 0) + 1);
            }

            const parts = Array.from(byCourse.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .map(([label, value]) => ({ label, value }));

            document.getElementById('courseViz').innerHTML = parts.length ? buildDonutSvg(parts) : '<div class="muted" style="padding: 10px;">No course mix yet.</div>';

            return { busiestLabel, pulseCounts: counts };
        }

        function renderDashboard(data) {
            const courses = Array.isArray(data.courses) ? data.courses : [];
            const assignments = Array.isArray(data.assignments) ? data.assignments : [];
            const planner = Array.isArray(data.planner_items) ? data.planner_items : [];
            const calendar = Array.isArray(data.calendar_events) ? data.calendar_events : [];
            const modules = Array.isArray(data.modules) ? data.modules : [];
            const submissions = Array.isArray(data.submissions) ? data.submissions : [];
            const discussions = Array.isArray(data.discussion_topics) ? data.discussion_topics : [];
            const syllabi = Array.isArray(data.syllabi) ? data.syllabi : [];
            const inboxMessages = Array.isArray(data.inbox_messages) ? data.inbox_messages : [];

            const byAssignmentId = new Map(assignments.map((a) => [String(a?.id), a?.name]).filter(([id, name]) => id && name));
            for (const s of submissions) {
                if (!s || s.cached_assignment_name) continue;
                const name = byAssignmentId.get(String(s.assignment_id));
                if (name) s.cached_assignment_name = name;
            }
            const completedSet = buildCompletedAssignmentSet(submissions);
            currentCanvasOrigin = '';

            const { busiestLabel } = buildVisuals(data);

            renderUpcoming(assignments, completedSet);
            renderGrades(data.grades || []);
            renderPlanner([...(Array.isArray(planner) ? planner : []), ...(Array.isArray(calendar) ? calendar : [])]);
            renderAnnouncements(data.announcements || []);
            renderInbox(data.announcements || [], inboxMessages);
            renderModules(modules);
            renderSubmissions(submissions);
            renderDiscussions(discussions);
            renderSyllabi(syllabi);
            renderPriorityQueue(assignments, planner, calendar, completedSet);
            renderQuickActions(data.grades || [], assignments, planner, calendar, data.announcements || [], completedSet);
            renderCommandQueue(assignments, planner, calendar, completedSet);
            renderGradeWatch(data.grades || [], assignments, completedSet);
            renderMessageActions(data.announcements || [], inboxMessages);
            updateTodaySnapshot(data, completedSet);

            const filteredAssignments = assignments.filter((a) => isCourseMatch(a));
            const filteredPlanner = planner.filter((p) => isCourseMatch(p));
            const filteredCalendar = calendar.filter((e) => isCourseMatch(e));
            document.getElementById('kpiCourses').textContent = selectedCourse === '__all__'
                ? courses.length
                : new Set(filteredAssignments.map((a) => getCourseKey(a)).filter(Boolean)).size || 1;
            document.getElementById('kpiAssignments').textContent = filteredAssignments.filter((a) => !isAssignmentComplete(a, completedSet)).length;
            document.getElementById('kpiEvents').textContent = filteredPlanner.length + filteredCalendar.length;

            const upcoming = normalizeUpcoming(assignments, completedSet);
            const nextDue = getItemDate(upcoming[0]);
            document.getElementById('kpiNextDue').textContent = nextDue ? `Next due: ${formatWhen(nextDue)}` : 'Next due: -';
            document.getElementById('kpiBusiest').textContent = busiestLabel ? `Busiest day: ${busiestLabel}` : 'Busiest day: -';

            const syncedAt = data.synced_at ? formatWhen(data.synced_at) : '-';
            document.getElementById('kpiSyncedAt').textContent = `Last sync: ${syncedAt} (${userTimeZone})`;
        }

        async function loadCanvasDashboard() {
            const empty = document.getElementById('emptyState');
            const dash = document.getElementById('dashboard');
            const refreshBtn = document.getElementById('refreshBtn');

            try {
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.textContent = 'Refreshing...';
                }
                if (dash) dash.classList.add('loading');
                setStatus('Checking for synced Canvas data...', 'warning');
                const resp = await apiFetch(`${CANVAS_API_URL}/data`);

                if (resp.status === 404) {
                    empty.style.display = 'block';
                    dash.style.display = 'none';
                    setStatus('No Canvas data yet. Sync via extension first.', 'warning');
                    return;
                }

                const data = await resp.json();
                if (data.error) throw new Error(data.error);

                empty.style.display = 'none';
                dash.style.display = 'block';
                currentCanvasData = data;
                buildCourseFilter(data);
                renderDashboard(data);
                generateWeeklyPlan();

                refreshQuickFilterButtons();
                setDashTab(defaultDashboardTab);
                setStatus('Dashboard updated.', 'success');
            } catch (e) {
                setStatus(`Dashboard error: ${e.message}`, 'error');
            } finally {
                if (dash) dash.classList.remove('loading');
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'Refresh Dashboard';
                }
            }
        }

        window.addEventListener('load', async () => {
            initializeTheme();
            readDashboardPrefs();
            refreshQuickFilterButtons();
            if (!sessionToken) {
                redirectToLogin();
                return;
            }

            setUserUI();
            initDashTabs();

            try {
                const response = await apiFetch(`${BASE_API_URL}/auth/me`);
                if (!response.ok) redirectToLogin();
            } catch (e) {}

            window.addEventListener('keydown', (ev) => {
                const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : '';
                const typing = tag === 'input' || tag === 'textarea' || ev.target?.isContentEditable;
                if (!typing && ev.key === '/') {
                    ev.preventDefault();
                    document.getElementById('dashboardSearch')?.focus();
                    return;
                }
                const key = String(ev.key || '').toLowerCase();
                const now = Date.now();
                if (!typing && lastShortcutKey === 'g' && (now - lastShortcutTs) < 1200) {
                    if (key === 'c') window.location.href = 'index.html';
                    if (key === 'd') window.location.href = 'dashboard.html';
                    if (key === 's') window.location.href = 'settings.html';
                    lastShortcutKey = '';
                    return;
                }
                lastShortcutKey = key === 'g' ? 'g' : '';
                lastShortcutTs = now;
            });

            await loadCanvasDashboard();
        });
    </script>
</body>
</html>
